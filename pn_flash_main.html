<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Theory Flash Cards (Staff Notation)</title>
    <!-- Include the abcjs library from multiple CDNs with fallbacks -->
    <script>
        // Function to load script with fallback
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            script.onerror = function() {
                console.error("Failed to load script:", src);
                if (typeof callback === 'function') callback(new Error("Script load failed"));
            };
            document.head.appendChild(script);
        }
        // Check if a local file exists first, then try CDNs
        function checkFileExists(url, onExists, onNotExists) {
            fetch(url, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        onExists();
                    } else {
                        onNotExists();
                    }
                })
                .catch(() => {
                    onNotExists();
                });
        }
        // First check for a local copy of the library
        checkFileExists('abcjs-basic-min.js', 
            function() {
                // Local file exists, use it
                loadScript("abcjs-basic-min.js", function(err) {
                    if (err) {
                        loadFromCDNs(); // Fall back to CDNs if local file fails
                    }
                });
            },
            loadFromCDNs // No local file, try CDNs
        );
        // CDN loading function
        function loadFromCDNs() {
            // Try to load from jsDelivr first, then unpkg as fallback
            loadScript("https://cdn.jsdelivr.net/npm/abcjs@6.2.2/dist/abcjs-basic-min.js", function(err) {
                if (err) {
                    console.log("Trying fallback CDN...");
                    loadScript("https://unpkg.com/abcjs@6.2.2/dist/abcjs-basic-min.js", function(err) {
                        if (err) {
                            console.error("All CDNs failed. Please check your internet connection or try again later.");
                            // Note: Don't set error message here, let the checkAbcjsAndRender function handle it
                        }
                    });
                }
            });
        }
    </script>
    <style>
        /* CSS Styling with Piano Ninja theme */
        body {
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #171724; /* Dark blue-black background */
            color: #0f0; /* Neon green text */
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: relative;
        }

        /* Add a wrapper for the game content to help with positioning */
        .game-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 10px 0;
        }

        /* Further optimize the logo */
        .logo-container {
            position: relative;
            width: 100%;
            max-width: 120px; /* Further reduced size */
            margin: 0 auto 5px;
            text-align: center;
            z-index: 1;
        }

        /* Move floating notes to be less distracting */
        .floating-note {
            opacity: 0.5; /* Reduced from 0.7 */
        }

        /* Make the staff area more efficient (balancing space) */
        #staff-area {
            margin: 10px auto; /* Center the block horizontally, keep vertical margin */
            padding: 10px 15px 60px 15px; /* Reduced bottom padding from 80px */
            background-color: rgba(14, 14, 26, 0.95);
            border: 1px solid #3dff3d33;
            border-radius: 4px;
            min-height: 180px; /* Reduced min-height from 200px */
            height: auto; /* Use auto height */
            /* overflow: hidden; */ /* Keep overflow visible */
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.1);
            /* Ensure it doesn't exceed container width if SVG is wider */
            max-width: 100%; 
            box-sizing: border-box; /* Include padding and border in width calculation */
        }

        /* Make instructions more compact but still readable */
        .instructions {
            padding-top: 8px; /* Reduced from 15px */
            font-size: 0.8em; /* Further reduced size */
        }

        .instructions ul {
            margin: 5px 0 0 0;
            padding-left: 10px;
        }

        /* Background staff lines */
        .bg-staff {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.2;
            pointer-events: none;
        }
        .staff-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: #0f0;
            box-shadow: 0 0 5px #0f0;
        }
        /* Animated staff note */
        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-15px) rotate(5deg); opacity: 1; }
            100% { transform: translateY(0) rotate(0deg); opacity: 0.7; }
        }
        .floating-note {
            position: absolute;
            color: #0f0;
            font-size: 2.5em;
            text-shadow: 0 0 5px #0f0;
            animation: float 3s infinite ease-in-out;
            opacity: 0.7;
            z-index: -1;
        }

        h1 {
            font-size: 1.8em; /* Further reduced from 2em */
            margin-top: 0;
            margin-bottom: 10px; /* Further reduced from 15px */
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 10px #0f0, 0 0 20px #0f0;
            font-family: 'Courier New', monospace;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { text-shadow: 0 0 10px #0f0, 0 0 20px #0f0; }
            50% { text-shadow: 0 0 15px #0f0, 0 0 30px #0f0; }
            100% { text-shadow: 0 0 10px #0f0, 0 0 20px #0f0; }
        }

        #game-container {
            background-color: rgba(23, 23, 36, 0.9);
            padding: 20px 30px; /* Reduced top/bottom padding from 30px to 20px */
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2), inset 0 0 10px rgba(0, 255, 0, 0.1);
            text-align: center;
            width: 550px;
            border: 1px solid #0f07;
            position: relative;
            z-index: 1;
        }

         /* Style for placeholder text before staff renders */
        #staff-placeholder {
            font-size: 1.5em;
            color: #0f08;
            text-shadow: 0 0 5px #0f0;
        }

        #feedback-area {
            font-size: 1.2em;
            margin-top: 5px; /* Reduced from 10px */
            min-height: 1em; /* Reduced from 1.2em */
            height: 1.2em; /* Fixed height to prevent layout shifts */
            font-weight: bold;
            letter-spacing: 1px;
        }

        .correct { 
            color: #0f0; 
            text-shadow: 0 0 10px #0f0;
        }
        .incorrect { 
            color: #f00; 
            text-shadow: 0 0 10px #f00;
        }
        .intermediate { 
            color: #0ff; 
            text-shadow: 0 0 10px #0ff;
        }

        #score-area {
            font-size: 1.1em;
            margin-top: 15px; /* Reduced from 20px */
            text-transform: uppercase;
            letter-spacing: 2px;
            display: inline-block;
            padding: 10px 20px;
            border: 1px solid #0f05;
            border-radius: 4px;
            background-color: rgba(0, 255, 0, 0.05);
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.2);
        }

        /* Game Stats Bar styling */
        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px; /* Reduced from 20px */
        }
        .stat-box {
            flex: 1;
            margin: 0 5px;
            padding: 8px; /* Reduced from 10px */
            border: 1px solid #0f07;
            border-radius: 4px;
            background-color: rgba(0, 255, 0, 0.05);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-icon {
            font-size: 1.2em;
            margin-bottom: 5px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        .stat-label {
            font-size: 0.9em; /* Increased from 0.7em */
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 3px;
            color: #0f0;
            font-weight: bold;
        }
        .stat-value {
            font-family: monospace;
            font-size: 1.3em; /* Increased from 1.1em */
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }

        #start-button {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            padding: 10px 20px; /* Slightly smaller padding */
            margin-top: 10px; /* Reduced from 15px */
            cursor: pointer;
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
        }

        #start-button:hover { 
            background-color: rgba(0, 255, 0, 0.2); 
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        #start-button:active {
            transform: scale(0.98);
        }

        /* Pause button styling */
        #pause-button {
            font-family: 'Courier New', monospace;
            font-size: 1em;
            padding: 8px 15px;
            margin-left: 10px;
            cursor: pointer;
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
        }

        #pause-button:hover {
            background-color: rgba(0, 255, 0, 0.2); 
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        /* Pause overlay styling */
        #pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            backdrop-filter: blur(5px);
        }

        .pause-content {
            background-color: rgba(23, 23, 36, 0.95);
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #0f0;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            max-width: 400px;
        }

        .pause-content h2 {
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #0f0;
            letter-spacing: 4px;
        }

        .pause-content p {
            margin-bottom: 25px;
            color: #0f0a;
            font-size: 1.1em;
        }

        #resume-button {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            padding: 12px 25px;
            cursor: pointer;
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
        }

        #resume-button:hover {
            background-color: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        .instructions {
            font-size: 0.85em; /* Slightly smaller */
            margin-top: 15px; /* Reduced from original */
            text-align: left;
            line-height: 1.3; /* Tighter line height */
            border-top: 1px solid #0f05;
            padding-top: 15px;
        }
        .instructions strong {
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            letter-spacing: 1px;
        }
        .instructions ul { 
            padding-left: 20px; 
            list-style-type: none;
        }
        .instructions li {
            margin-bottom: 5px; /* Tighter spacing */
            position: relative;
            padding-left: 15px;
        }
        .instructions li:before {
            content: ">";
            position: absolute;
            left: 0;
            color: #0f0;
        }
        /* Custom styling for the ABC.js output */
        svg {
            filter: drop-shadow(0 0 1px rgba(0, 255, 0, 0.3));
        }
        /* Make the staff lines green */
        svg path {
            stroke: #3dff3d !important;
            stroke-width: 1.1px !important;
        }
        /* Make note heads and other elements green */
        svg g.abcjs-note path, 
        svg path.abcjs-stem {
            fill: #3dff3d !important;
            stroke: #3dff3d !important;
            stroke-width: 1.1px !important;
        }
        /* Make note circles glow */
        svg ellipse {
            fill: #3dff3d !important;
            stroke: #3dff3d !important;
            filter: drop-shadow(0 0 1px #0f0);
        }
        
        .middle-c-indicator {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: #0f0;
            text-transform: uppercase;
        }

        /* Timer bar styling */
        #timer-container {
            width: 100%;
            height: 8px;
            background-color: rgba(0, 255, 0, 0.1);
            border-radius: 4px;
            margin: 15px 0; /* Original spacing */
            position: relative;
            overflow: hidden;
        }
        
        /* Type selector styling */
        #type-selector {
            margin-bottom: 10px; /* Reduced from original */
            font-size: 0.9em;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #type-selector span {
            margin-right: 10px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            letter-spacing: 1px;
        }
        
        .type-btn {
            font-family: 'Courier New', monospace;
            padding: 8px 15px;
            margin: 0 5px;
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }
        
        .type-btn:hover {
            background-color: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        .type-btn.active {
            background-color: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
        }
        
        #timer-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #0f0, #0ff);
            transform-origin: left;
            transition: transform 100ms linear;
        }
        
        #points-indicator {
            position: absolute;
            right: 0;
            top: -20px;
            font-size: 0.9em;
            color: #0f0;
        }
        
        /* Points animation */
        @keyframes pointsFade {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        .points-popup {
            position: absolute;
            font-size: 1.2em;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            animation: pointsFade 1.2s forwards;
            pointer-events: none;
        }

        /* Interval button styles */
        #interval-buttons {
            /* Styles for the overall container if needed, e.g., margin */
            margin-top: 15px; 
            margin-bottom: 15px;
        }
        
        #interval-buttons h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }

        #interval-buttons p {
            margin-bottom: 10px;
            font-size: 1em;
            color: #0f0a;
        }

        /* Grid layout for interval choice buttons - Enhanced for dynamic count */
        .interval-choice-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px; /* Increased spacing between buttons */
            margin-top: 15px;
        }

        .interval-choice-btn {
            /* Base styling for interval buttons */
            font-family: 'Courier New', monospace;
            font-size: 1em; /* Slightly larger font */
            padding: 12px 15px;
            cursor: pointer;
            border: 1px solid #0f0;
            border-radius: 4px;
            background-color: rgba(0, 255, 0, 0.05);
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            text-align: center;
            transition: all 0.2s;
            flex: 0 1 auto; /* Don't stretch buttons */
            min-width: 150px; /* Minimum width for each button */
            max-width: 100%; /* Ensure buttons don't overflow container */
        }

        /* Adjust button sizes based on number of options */
        .interval-choice-buttons.options-2 .interval-choice-btn {
            flex-basis: calc(50% - 15px); /* 2 options per row with gap */
            min-width: 200px; /* Wider buttons for fewer options */
        }

        .interval-choice-buttons.options-3 .interval-choice-btn {
            flex-basis: calc(33.333% - 15px); /* 3 options per row with gap */
        }

        .interval-choice-buttons.options-4 .interval-choice-btn, 
        .interval-choice-buttons.options-5 .interval-choice-btn {
            flex-basis: calc(50% - 15px); /* 2 options per row for 4-5 options */
        }

        .interval-choice-btn:hover {
            background-color: rgba(0, 255, 0, 0.15);
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.3);
        }

        /* Styling for selected/correct/incorrect states (from handleIntervalChoiceClick) */
        .interval-choice-btn.selected {
            /* Maybe a thicker border or different background */
            border-width: 2px;
        }
        .interval-choice-btn.correct {
            background-color: rgba(0, 255, 0, 0.3);
            border-color: #8f8;
            color: #fff;
            text-shadow: 0 0 8px #fff;
        }
        .interval-choice-btn.incorrect {
            background-color: rgba(255, 0, 0, 0.3);
            border-color: #f88;
            color: #fcc;
            text-shadow: none;
        }

        /* --- End Interval Buttons Styling --- */

        /* --- Additional CSS for the note guide overlay --- */
        #note-guide-btn {
            font-family: 'Courier New', monospace;
            font-size: 1em;
            padding: 8px 15px;
            margin-left: 10px;
            cursor: pointer;
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
            margin-top: 10px; /* Assuming it should align with start button */
        }

        #note-guide-btn:hover {
            background-color: rgba(0, 255, 0, 0.2); 
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        #note-guide-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            backdrop-filter: blur(5px);
        }

        .note-guide-content {
            background-color: rgba(23, 23, 36, 0.95);
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #0f0;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .note-guide-content h2 {
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #0f0;
            letter-spacing: 4px;
        }

        #close-guide-btn {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            padding: 12px 25px;
            margin-top: 20px;
            cursor: pointer;
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
        }

        #close-guide-btn:hover {
            background-color: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        /* Update styles for the clef symbols and note guide */
        .clef-label {
            position: absolute;
            left: 40px;
            color: #0f0;
            font-size: 4.5em; /* Even larger clef symbols */
            text-shadow: 0 0 10px #0f0;
            transform: translateY(-50%);
        }

        /* Completely redesign the staff guide layout */
        .staff-guide {
            position: relative;
            margin: 30px 0;
            padding: 20px 0;
            width: 100%;
            height: 220px; /* Fixed height for consistent spacing */
        }

        .staff-line-guide {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #0f0;
            box-shadow: 0 0 5px #0f0;
        }

        /* Create a consistent note position system */
        .note-positions {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            height: 220px;
        }

        .note-marker {
            position: absolute;
            left: 50%;
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #0f0;
            font-size: 1.1em;
            text-shadow: 0 0 5px #0f0;
        }

        .note-marker .circle {
            width: 18px; /* Adjust size */
            height: 18px;
            border-radius: 50%;
            background-color: #0f0;
            margin-right: 8px;
            box-shadow: 0 0 8px #0f0;
            border: 1px solid #0005; /* Optional subtle border */
            position: relative; /* For positioning the ledger line */
        }
        .note-marker .ledger-line {
            position: absolute;
            width: 30px; /* Width of the ledger line */
            height: 2px;
            background-color: #0f0;
            box-shadow: 0 0 3px #0f0;
            left: -15px; /* Move further left */
            right: auto;
            top: 9px; /* Center on the note circle */
            transform: none;
            z-index: -1; /* Behind the note circle */
        }
        .middle-c-marker {
            color: #0ff; /* Highlight Middle C */
        }
        .middle-c-marker .circle {
            background-color: #0ff;
            box-shadow: 0 0 8px #0ff;
        }
        .middle-c-marker .ledger-line {
            background-color: #0ff;
            box-shadow: 0 0 3px #0ff;
            left: -15px; /* Match the general ledger line position */
            top: 9px; /* Center on the note circle */
        }

        .clef-title {
            font-size: 1.3em;
            margin: 20px 0 15px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .guide-section {
            border-top: 1px solid #0f05;
            padding-top: 20px;
            margin-top: 20px;
        }

        .guide-explanation {
            text-align: left;
            line-height: 1.6;
            margin-top: 15px;
            color: #0f0d;
        }

        .guide-explanation p {
            margin-bottom: 10px;
        }

        .guide-explanation strong {
            color: #0f0;
            text-shadow: 0 0 2px #0f0;
        }

        /* Piano keyboard styling */
        .piano-keyboard {
            display: flex;
            position: relative;
            height: 120px;
            margin: 30px auto;
            width: 90%;
            max-width: 700px;
        }

        .piano-white-key {
            flex: 1;
            background-color: #f5f5f5;
            border: 1px solid #171724;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 10px;
        }

        .piano-black-key {
            position: absolute;
            width: 60%;
            height: 60%;
            background-color: #111;
            z-index: 2;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 5px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }

        .key-note-name {
            font-weight: bold;
            color: #111;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .key-shortcut {
            color: #555;
            font-size: 12px;
        }

        .black-key-note-name {
            font-weight: bold;
            color: #fff;
            margin-bottom: 3px;
            font-size: 12px;
        }

        .black-key-shortcut {
            color: #ccc;
            font-size: 9px;
        }

        .middle-c-indicator {
            color: #ff0;
        }

        .middle-c-indicator .circle {
            background-color: #ff0; 
            box-shadow: 0 0 10px #ff0;
        }

        /* --- NEW Note Guide Styles --- */

        .guide-section {
            border-top: 1px solid #0f05;
            padding-top: 20px;
            margin-top: 20px;
            position: relative; /* Needed for positioning children */
        }
        .clef-title {
            font-size: 1.3em;
            margin: 0 0 15px; /* Adjusted margin */
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: left; /* Align title left */
        }

        .staff-container {
            position: relative;
            width: 90%; /* Adjust width as needed */
            height: 120px; /* Height for the 5 lines + space above/below */
            margin: 30px auto; /* Center staff and add vertical margin */
            /* background-color: rgba(0,255,0,0.03); */ /* Optional: Debug background */
        }

        .staff-line-guide {
            position: absolute;
            left: 10%; /* Indent lines slightly */
            right: 0;
            height: 2px;
            background-color: #0f0;
            box-shadow: 0 0 3px #0f0;
            z-index: 1; /* Below notes */
        }

        .clef-symbol {
            position: absolute;
            left: 0; /* Position clef at the start */
            font-size: 6em; /* Adjust size */
            color: #0f0;
            text-shadow: 0 0 8px #0f0;
            z-index: 2; /* Above lines */
            line-height: 1;
        }

        .clef-symbol.treble {
             /* Vertically center the G-clef curl around the 2nd line from bottom (70%) */
            top: 70%;
            transform: translateY(-60%); /* Fine-tune vertical alignment */
        }
        .clef-symbol.bass {
            /* Vertically center the F-clef dots around the 2nd line from top (30%) */
            top: 30%;
             transform: translateY(-50%); /* Fine-tune vertical alignment */
        }

        .note-marker {
            position: absolute;
            transform: translate(-50%, -50%); /* Center marker on its top/left coordinates */
            display: flex;
            align-items: center;
            color: #0f0;
            font-size: 1em; /* Adjust font size */
            text-shadow: 0 0 5px #0f0;
            z-index: 3; /* Above clef and lines */
            white-space: nowrap; /* Prevent name wrapping */
        }

        .note-marker .circle {
            width: 18px; /* Adjust size */
            height: 18px;
            border-radius: 50%;
            background-color: #0f0;
            margin-right: 8px;
            box-shadow: 0 0 8px #0f0;
            border: 1px solid #0005; /* Optional subtle border */
            position: relative; /* For positioning the ledger line */
        }
        .note-marker .ledger-line {
            position: absolute;
            width: 30px; /* Wider than the circle */
            height: 2px;
            background-color: #0f0;
            box-shadow: 0 0 3px #0f0;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%); /* Center on the circle */
            z-index: -1; /* Behind the circle */
        }
        .note-marker .note-name {
            font-weight: bold;
        }

        .note-marker .ledger-line {
            position: absolute;
            width: 30px; /* Width of the ledger line */
            height: 2px;
            background-color: #0f0;
            box-shadow: 0 0 3px #0f0;
            left: 0; /* Start at the left edge of the marker */
            right: auto;
            top: 9px; /* Center on the note circle */
            transform: none;
            z-index: -1; /* Behind the note circle */
        }
        .middle-c-marker {
            color: #0ff; /* Highlight Middle C */
        }
        .middle-c-marker .circle {
             background-color: #0ff;
             box-shadow: 0 0 8px #0ff;
        }

        .middle-c-marker .ledger-line {
            background-color: #0ff;
            box-shadow: 0 0 3px #0ff;
            left: 0; /* Start at the left edge of the marker */
            top: 9px; /* Center on the note circle */
        }

        .guide-explanation {
            text-align: left;
            line-height: 1.7; /* Increased line height */
            margin-top: 15px;
            color: #0f0d;
            padding-left: 10px; /* Indent text */
        }

        .guide-explanation p {
            margin-bottom: 12px; /* Spacing between paragraphs */
        }
        .guide-explanation strong {
            color: #0f0;
            text-shadow: 0 0 2px #0f0;
            font-weight: bold;
        }
        .guide-explanation em {
            color: #0ff; /* Highlight mnemonics */
            font-style: normal;
            font-weight: bold;
        }
        .guide-explanation br {
             display: block; /* Ensure <br> creates space */
             margin-bottom: 0.5em;
        }
        /* --- End NEW Note Guide Styles --- */
        /* --- Piano Keyboard Guide Styles --- */
        .piano-keyboard-guide {
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            border: 1px solid #000;
        }
        
        .piano-keyboard {
            display: flex;
            height: 120px;
            position: relative;
            background-color: #fff;
        }
        .white-key {
            flex: 1;
            background: #fff;
            border-right: 1px solid #000;
            position: relative;
            z-index: 1;
            height: 100%;
        }
        .white-key:last-child {
            border-right: none;
        }
        .black-key-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none;
        }
        .black-key {
            position: absolute;
            width: 8%;
            height: 65%;
            background: #000;
            top: 0;
        }
        /* Position black keys correctly in the 2-3-2 pattern */
        .key-c-sharp {
            left: 14.3%;
        }
        .key-d-sharp {
            left: 28.6%;
        }
        .key-f-sharp {
            left: 57.1%;
        }
        .key-g-sharp {
            left: 71.4%;
        }
        .key-a-sharp {
            left: 85.7%;
        }
        .key-name {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 14px;
            color: #000;
            font-family: Arial, sans-serif;
        }

        .explanation-block h2 {
            border-bottom: 1px solid #5cff5c;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        /* Styles for interval choices */
        .interval-choices {
            margin: 20px 0;
        }
        
        .interval-choice-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px; /* Spacing between buttons */
            margin-top: 10px;
        }
        
        .interval-choice-btn {
            padding: 12px 20px;
            font-size: 16px;
            background-color: #333;
            color: #5cff5c;
            border: 2px solid #5cff5c;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 180px;
            margin-bottom: 10px;
        }
        
        .interval-choice-btn:hover {
            background-color: #444;
            transform: translateY(-2px);
        }
        
        .interval-choice-btn.selected {
            background-color: #5cff5c;
            color: #000;
        }
        
        .interval-choice-btn.correct {
            background-color: #00ff00;
            color: #000;
            border-color: #00ff00;
        }
        
        .interval-choice-btn.incorrect {
            background-color: #ff3333;
            color: #fff;
            border-color: #ff3333;
        }

        @media (max-width: 600px) {
            .interval-choice-btn {
                min-width: 150px;
                padding: 10px 15px;
            }
        }
        
        /* Toggle for keyboard display */
        /* ... existing code ... */

        /* Logo styling - even more compact */
        .logo-container {
            position: relative;
            width: 100%;
            max-width: 150px; /* Further reduced from 180px */
            margin: 0 auto 5px; /* Further reduced bottom margin from 10px to 5px */
            text-align: center;
            z-index: 1;
        }
        .logo-container img {
            width: 100%;
            height: auto;
        }

        /* End Game button styling (similar to pause) */
        #end-game-btn {
            font-family: 'Courier New', monospace;
            font-size: 1em;
            padding: 8px 15px;
            margin-left: 10px;
            cursor: pointer;
            background-color: rgba(255, 0, 0, 0.2); /* Reddish background */
            color: #f88; /* Lighter red text */
            border: 1px solid #f88;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
            text-shadow: 0 0 5px #f88;
        }

        #end-game-btn:hover {
            background-color: rgba(255, 0, 0, 0.3); 
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
        }

        /* Scorecard Overlay Styling */
        #scorecard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* More opaque background */
            display: flex; /* Use flex for centering */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            backdrop-filter: blur(5px);
        }

        .scorecard-content {
            background-color: rgba(23, 23, 36, 0.95);
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #0f0;
            box-shadow: 0 0 40px rgba(0, 255, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }

        .scorecard-content h2 {
            font-size: 2.2em;
            margin-bottom: 25px;
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
            letter-spacing: 4px;
        }

        .scorecard-stats p {
            font-size: 1.2em;
            margin: 10px 0;
            color: #0f0c;
            text-align: left;
        }

        .scorecard-stats strong {
            color: #0f0;
            min-width: 120px; /* Align labels */
            display: inline-block;
        }

        #play-again-btn {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            padding: 12px 30px;
            margin-top: 30px;
            cursor: pointer;
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
        }

        #play-again-btn:hover {
            background-color: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        /* Pause overlay styling */
        #pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            backdrop-filter: blur(5px);
        }

        .pause-content {
            background-color: rgba(23, 23, 36, 0.95);
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #0f0;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            max-width: 400px;
        }

        .pause-content h2 {
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #0f0;
            letter-spacing: 4px;
        }

        .pause-content p {
            margin-bottom: 25px;
            color: #0f0a;
            font-size: 1.1em;
        }

        #resume-button {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            padding: 12px 25px;
            cursor: pointer;
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
        }

        #resume-button:hover {
            background-color: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        /* Setup Modal Overlay Styling */
        #setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); 
            display: flex; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .setup-modal-content {
            background-color: rgba(23, 23, 36, 0.95);
            padding: 30px 40px;
            border-radius: 8px;
            text-align: left; /* Align labels/inputs left */
            border: 1px solid #0f0;
            box-shadow: 0 0 40px rgba(0, 255, 0, 0.3);
            max-width: 500px;
            width: 90%;
            color: #0f0; /* Default text color */
        }

        .setup-modal-content h2 {
            font-size: 2em;
            margin-bottom: 25px;
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
            letter-spacing: 3px;
            text-align: center;
        }

        .setup-section {
            margin-bottom: 20px;
        }

        .setup-section label {
            display: block;
            margin-bottom: 8px;
            font-size: 1em;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .setup-section input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            background-color: rgba(14, 14, 26, 0.95);
            border: 1px solid #3dff3d33;
            border-radius: 4px;
            color: #0f0;
            font-family: monospace;
            font-size: 1.1em;
            box-sizing: border-box; /* Include padding in width */
        }

        .setup-section .radio-group {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .setup-section input[type="radio"] {
            margin-right: 8px;
            appearance: none; /* Custom radio button */
            width: 16px;
            height: 16px;
            border: 2px solid #0f0;
            border-radius: 50%;
            background-color: rgba(14, 14, 26, 0.95);
            cursor: pointer;
            position: relative;
            top: 2px;
        }

        .setup-section input[type="radio"]:checked {
            background-color: #0f0;
            box-shadow: 0 0 5px #0f0;
        }

        .setup-section .radio-group label {
            font-size: 1em;
            font-weight: normal;
            margin-bottom: 0; /* Override default label margin */
            cursor: pointer;
            display: inline-block; /* Keep label next to radio */
        }

        #begin-game-btn {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            padding: 12px 30px;
            margin-top: 10px; /* Adjusted margin */
            cursor: pointer;
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
            display: block; /* Make button full width */
            width: 100%;
            box-sizing: border-box;
        }

        #begin-game-btn:hover {
            background-color: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        /* --- Main Game Controls --- */
        #main-controls {
            display: flex;
            justify-content: center;
            align-items: center; /* Vertically align buttons */
            gap: 15px; /* Spacing between buttons */
            margin-top: 20px; /* Space above controls */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            min-height: 42px; /* Match button height */
            position: relative; /* For proper alignment */
        }

        /* Reset any button-specific styles that might affect layout */
        #setup-game-btn, #pause-button, #end-game-btn, #note-guide-btn {
            margin: 0;
            font-size: 0.95em; /* Ensure all buttons have identical font size */
            height: 42px; /* Ensure consistent height */
            line-height: 1; /* Consistent line height */
        }

        /* Base style for control buttons */
        .control-btn {
            font-family: 'Courier New', monospace;
            font-size: 0.95em; /* Consistent font size */
            padding: 0 20px; /* Horizontal padding only */
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            border: 1px solid;
            box-shadow: 0 0 10px;
            text-shadow: 0 0 5px;
            margin: 0; /* Remove individual margins */
            min-width: 140px; /* Ensure consistent width */
            width: auto; /* Allow for text content */
            height: 42px; /* Fixed height for consistency */
            text-align: center; /* Center text */
            display: inline-flex; /* Use flexbox for better alignment */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            box-sizing: border-box; /* Include padding in dimensions */
            line-height: 1; /* Consistent line height */
            position: relative; /* Needed for consistent positioning */
            vertical-align: middle; /* Ensure consistent baseline */
        }

        /* Base hover effect for all control buttons */
        .control-btn:hover {
            box-shadow: 0 0 15px;
            transform: translateY(-1px); /* Subtle lift effect */
        }

        /* Specific Button Colors Only - No Layout/Sizing Properties */
        #setup-game-btn {
            background-color: rgba(0, 200, 255, 0.1); /* Cyan tint */
            color: #0cf;
            border-color: #0cf;
            box-shadow: 0 0 10px rgba(0, 200, 255, 0.2);
            text-shadow: 0 0 5px #0cf;
        }
        #setup-game-btn:hover {
            background-color: rgba(0, 200, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 200, 255, 0.4);
            /* No duplicate layout properties */
        }

        #pause-button {
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border-color: #0f0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
        }
        #pause-button:hover {
            background-color: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
            /* No duplicate layout properties */
        }

        #end-game-btn {
            background-color: rgba(255, 0, 0, 0.2);
            color: #f88;
            border-color: #f88;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
            text-shadow: 0 0 5px #f88;
        }
        #end-game-btn:hover {
            background-color: rgba(255, 0, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            /* No duplicate layout properties */
        }

        #note-guide-btn {
            background-color: rgba(0, 255, 0, 0.1);
            color: #0f0;
            border-color: #0f0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 5px #0f0;
        }
        #note-guide-btn:hover {
            background-color: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
            /* No duplicate layout properties */
        }

        /* --- End Main Game Controls --- */

        .instructions {
            font-size: 0.85em; /* Slightly smaller */
            margin-top: 15px; /* Reduced from original */
            text-align: left;
            line-height: 1.3; /* Tighter line height */
            border-top: 1px solid #0f05;
            padding-top: 15px;
        }
        .instructions strong {
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            letter-spacing: 1px;
        }
        .instructions ul { 
            padding-left: 20px; 
            list-style-type: none;
        }
        .instructions li {
            margin-bottom: 5px; /* Tighter spacing */
            position: relative;
            padding-left: 15px;
        }
        .instructions li:before {
            content: ">";
            position: absolute;
            left: 0;
            color: #0f0;
        }
    </style>
</head>
<body>
    <!-- Background staff lines and notes - keep these outside the game container -->
    <div class="bg-staff">
        <div class="staff-line" style="top: 20%;"></div>
        <div class="staff-line" style="top: 30%;"></div>
        <div class="staff-line" style="top: 40%;"></div>
        <div class="staff-line" style="top: 50%;"></div>
        <div class="staff-line" style="top: 60%;"></div>
        <!-- Animated floating music symbols -->
        <div class="floating-note" style="top: 15%; left: 10%; animation-delay: 0s;">♩</div>
        <div class="floating-note" style="top: 25%; left: 85%; animation-delay: 0.5s;">♪</div>
        <div class="floating-note" style="top: 75%; left: 20%; animation-delay: 1s;">♫</div>
        <div class="floating-note" style="top: 65%; left: 75%; animation-delay: 1.5s;">♬</div>
        <div class="floating-note" style="top: 45%; left: 5%; animation-delay: 2s;">𝄞</div>
    </div>

    <div class="game-wrapper">
    <div id="game-container">
            <!-- Add logo inside game container at the top -->
            <div class="logo-container">
                <img src="PianoNinja_Logo.png" alt="Piano Ninja Logo">
            </div>
            
            <!-- Remove redundant title -->
            <!-- Game Stats Bar -->
            <div class="game-stats">
                <div class="stat-box">
                    <div class="stat-icon">🎓</div> <!-- Teacher/Educator Icon -->
                    <div class="stat-label">TEACHER</div>
                    <div class="stat-value" id="teacher-name">Teacher</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon">👤</div> <!-- Student Icon -->
                    <div class="stat-label">STUDENT</div>
                    <div class="stat-value" id="student-name">Student</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-icon">★</div>
                    <div class="stat-label">SCORE</div>
                    <div class="stat-value"><span id="score">0</span></div>
                </div>

                <div class="stat-box"> <!-- Added Timer Box -->
                    <div class="stat-icon">⏱️</div>
                    <div class="stat-label">TIME</div>
                    <div class="stat-value" id="elapsed-time">0:00</div> 
                </div>
            </div>

        <!-- Div where abcjs will render the staff -->
        <div id="staff-area">
             <div id="staff-placeholder">Press Start!</div>
        </div>

            <!-- Timer bar -->
            <div id="timer-container" style="display: none;">
                <div id="timer-bar"></div>
                <div id="points-indicator">+1000</div>
            </div>
            
            <!-- Moved Feedback Area Above Interval Buttons -->
            <div id="feedback-area"> </div> 

            <!-- Interval-specific buttons (only shown in intervals mode) -->
            <div id="interval-buttons" class="button-area" style="display: none;">
                <!-- REMOVED h3 and p tags -->
                <div id="interval-choices" class="interval-choices">
                    <div class="interval-choice-buttons">
                        <!-- Buttons will be generated dynamically -->
                    </div>
                </div>
        </div>

            <!-- Feedback Area (Original Position - Removed) -->
            <!-- <div id="feedback-area"> </div> -->

            <div id="main-controls"> <!-- Added wrapper div -->
                <button id="setup-game-btn" class="control-btn">Launch New Game</button> 
                <button id="pause-button" class="control-btn" style="display: none; position: relative; top: 0;">Pause</button>
                <button id="end-game-btn" class="control-btn" style="display: none; position: relative; top: 0;">End</button> 
                <button id="note-guide-btn" class="control-btn">Guide</button>
            </div>

        <div class="instructions">
            <strong>How to Play:</strong>
            <ul>
                        <li>Select a game mode: Notes, Intervals, or Chords.</li>
                        <li><strong>Notes Mode:</strong> Press the letter key matching the note name (e.g., 'C' key for C).</li>
                        <li><strong>For Sharps/Flats:</strong> Hold Shift while pressing the note key for any accidental (e.g., Shift+C for C# or Shift+D for Db).</li>
                        <li><strong>Alternative:</strong> You can also use Alt+letter for flat notes (e.g., Alt+E for Eb).</li>
                        <li><strong>Intervals Mode:</strong> Click on the correct interval name from the multiple choice options provided.</li>
                        <li><strong>Chords Mode:</strong> Press the key for the ROOT note, then press 'm' if it's a minor chord.</li>
                        <li>The grand staff shows both treble and bass clefs simultaneously.</li>
                        <li>Musical elements may appear on either clef.</li>
            </ul>
                </div>
        </div>
    </div>

    <!-- Setup Modal Overlay -->
    <div id="setup-modal" style="display: none;">
        <div class="setup-modal-content">
            <h2>Game Setup</h2>
            
            <div class="setup-section">
                <label for="teacher-name-input">Teacher Name:</label>
                <input type="text" id="teacher-name-input" value="Teacher">
            </div>
            
            <div class="setup-section">
                <label for="student-name-input">Student Name:</label>
                <input type="text" id="student-name-input" value="Student">
            </div>
            
            <div class="setup-section">
                <label>Game Duration:</label>
                <div class="radio-group">
                    <input type="radio" id="duration-practice" name="gameDuration" value="practice" checked>
                    <label for="duration-practice">Practice (Untimed)</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="duration-5min" name="gameDuration" value="5min">
                    <label for="duration-5min">5 Minute Challenge</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="duration-10min" name="gameDuration" value="10min">
                    <label for="duration-10min">10 Minute Challenge</label>
                </div>
            </div>
            
            <div class="setup-section"> <!-- ADDED Game Mode Section -->
                <label>Game Mode:</label>
                <div class="radio-group">
                    <input type="radio" id="mode-notes" name="gameModeSelect" value="notes" checked>
                    <label for="mode-notes">Notes</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="mode-intervals" name="gameModeSelect" value="intervals">
                    <label for="mode-intervals">Intervals</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="mode-chords" name="gameModeSelect" value="chords">
                    <label for="mode-chords">Chords</label>
                </div>
            </div>
            
            <button id="begin-game-btn">Begin Game</button>
            <!-- Optional: <button id="cancel-setup-btn">Cancel</button> -->
        </div>
    </div>

    <!-- Scorecard Overlay -->
    <div id="scorecard-overlay" style="display: none;">
        <div class="scorecard-content">
            <h2 id="scorecard-title">Congratulations!</h2> <!-- Added ID -->
            <div class="scorecard-stats">
                <p><strong>Teacher:</strong> <span id="scorecard-teacher">Teacher</span></p>
                <p><strong>Student:</strong> <span id="scorecard-student">Student</span></p>
                <p><strong>Final Score:</strong> <span id="scorecard-score">0</span></p>
                <p><strong>Total Time:</strong> <span id="scorecard-time">0:00</span></p>
                <p><strong>Accuracy:</strong> <span id="scorecard-accuracy">0%</span></p>
                <!-- Add more detailed stats here later if needed -->
            </div>
            <button id="play-again-btn">Play Again</button>
        </div>
    </div>

    <!-- Pause overlay -->
    <div id="pause-overlay" style="display: none;">
        <div class="pause-content">
            <h2>GAME PAUSED</h2>
            <p>Press ESC or click Resume to continue</p>
            <button id="resume-button">Resume</button>
        </div>
    </div>
    <!-- Note Guide overlay -->
    <div id="note-guide-overlay" style="display: none;">
        <div class="note-guide-content">
            <h2>MUSIC NOTE GUIDE</h2>

            <!-- Treble Clef Section -->
            <div class="guide-section">
                <div class="clef-title">Treble Clef (G Clef)</div>
                <div class="staff-container treble-clef">
                    <!-- Staff Lines (5 lines) -->
                    <div class="staff-line-guide" style="top: 10%;"></div>
                    <div class="staff-line-guide" style="top: 30%;"></div>
                    <div class="staff-line-guide" style="top: 50%;"></div>
                    <div class="staff-line-guide" style="top: 70%;"></div>
                    <div class="staff-line-guide" style="top: 90%;"></div>

                    <!-- Clef Symbol -->
                    <div class="clef-symbol treble">𝄞</div>

                    <!-- Note Markers (Positioned relative to staff lines) -->
                    <div class="note-marker" style="top: 0%; left: 30%;"><div class="circle"></div><span class="note-name">G</span></div>
                    <div class="note-marker" style="top: 10%; left: 40%;"><div class="circle"></div><span class="note-name">F</span></div>
                    <div class="note-marker" style="top: 20%; left: 50%;"><div class="circle"></div><span class="note-name">E</span></div>
                    <div class="note-marker" style="top: 30%; left: 60%;"><div class="circle"></div><span class="note-name">D</span></div>
                    <div class="note-marker" style="top: 40%; left: 70%;"><div class="circle"></div><span class="note-name">C</span></div>
                    <div class="note-marker" style="top: 50%; left: 80%;"><div class="circle"></div><span class="note-name">B</span></div>
                    <div class="note-marker" style="top: 60%; left: 70%;"><div class="circle"></div><span class="note-name">A</span></div>
                    <div class="note-marker" style="top: 70%; left: 60%;"><div class="circle"></div><span class="note-name">G</span></div>
                    <div class="note-marker" style="top: 80%; left: 50%;"><div class="circle"></div><span class="note-name">F</span></div>
                    <div class="note-marker" style="top: 90%; left: 40%;"><div class="circle"></div><span class="note-name">E</span></div>
                    <div class="note-marker" style="top: 100%; left: 30%;">
                        <div class="circle"></div>
                        <span class="note-name">D</span>
                    </div>
                    <div class="note-marker middle-c-marker" style="top: 110%; left: 20%;">
                        <div class="circle">
                            <div class="ledger-line" style="position: absolute; width: 30px; height: 2px; background-color: #0ff; box-shadow: 0 0 3px #0ff; left: -6px; top: 50%; transform: translateY(-50%); z-index: -1;"></div>
                        </div>
                        <span class="note-name">C</span>
                    </div>
                </div>
            </div>

            <!-- Bass Clef Section -->
            <div class="guide-section">
                <div class="clef-title">Bass Clef (F Clef)</div>
                <div class="staff-container bass-clef">
                    <!-- Staff Lines (5 lines) -->
                    <div class="staff-line-guide" style="top: 10%;"></div>
                    <div class="staff-line-guide" style="top: 30%;"></div>
                    <div class="staff-line-guide" style="top: 50%;"></div>
                    <div class="staff-line-guide" style="top: 70%;"></div>
                    <div class="staff-line-guide" style="top: 90%;"></div>

                    <!-- Clef Symbol -->
                    <div class="clef-symbol bass">𝄢</div>

                    <!-- Note Markers (Positioned relative to staff lines) -->
                    <div class="note-marker" style="top: 10%; left: 60%;"><div class="circle"></div><span class="note-name">A</span></div>
                    <div class="note-marker" style="top: 20%; left: 50%;"><div class="circle"></div><span class="note-name">G</span></div>
                    <div class="note-marker" style="top: 30%; left: 40%;"><div class="circle"></div><span class="note-name">F</span></div>
                    <div class="note-marker" style="top: 40%; left: 30%;"><div class="circle"></div><span class="note-name">E</span></div>
                    <div class="note-marker" style="top: 50%; left: 20%;"><div class="circle"></div><span class="note-name">D</span></div>
                    <div class="note-marker" style="top: 60%; left: 30%;"><div class="circle"></div><span class="note-name">C</span></div>
                    <div class="note-marker" style="top: 70%; left: 40%;"><div class="circle"></div><span class="note-name">B</span></div>
                    <div class="note-marker" style="top: 80%; left: 50%;"><div class="circle"></div><span class="note-name">A</span></div>
                    <div class="note-marker" style="top: 90%; left: 60%;"><div class="circle"></div><span class="note-name">G</span></div>
                    <div class="note-marker" style="top: 100%; left: 70%;"><div class="circle"></div><span class="note-name">F</span></div>
                </div>
            </div>

            <!-- Keyboard Visual Aid Section -->
            <div class="guide-section">
                <div class="clef-title">Keyboard Note Map</div>
                <div class="piano-keyboard-guide" style="text-align: center;">
                    <!-- Using local image file instead of base64 -->
                    <img src="piano.png" alt="Piano keyboard showing one octave from C to C with black keys labeled" style="max-width: 500px; margin: 0 auto; display: block;">
                </div>
            </div>
             <!-- Combined Explanation -->
            <div class="guide-section">
                <div class="clef-title">Understanding the Staff</div>
                 <div class="guide-explanation">
                    <p><strong>The Grand Staff:</strong> Combines the Treble and Bass clefs. <strong>Middle C</strong> sits on a ledger line between the two staves (shown in cyan).</p>
                    <p><strong>Treble Clef (𝄞):</strong> Also called the G Clef because it circles the G4 line (second line from the bottom). Used for higher notes (piano right hand, flute, violin, etc.).</p>
                     <p><em>Line Notes (Bottom to Top):</em> E - G - B - D - F <br/>(Mnemonic: <strong>E</strong>very <strong>G</strong>ood <strong>B</strong>oy <strong>D</strong>eserves <strong>F</strong>udge)</p>
                     <p><em>Space Notes (Bottom to Top):</em> F - A - C - E <br/>(Mnemonic: Spells <strong>FACE</strong>)</p>
                    <p><strong>Bass Clef (𝄢):</strong> Also called the F Clef. The dots surround the F3 line (second line from the top). Used for lower notes (piano left hand, cello, bass guitar, etc.).</p>
                    <p><em>Line Notes (Bottom to Top):</em> G - B - D - F - A <br/>(Mnemonic: <strong>G</strong>ood <strong>B</strong>oys <strong>D</strong>o <strong>F</strong>ine <strong>A</strong>lways)</p>
                     <p><em>Space Notes (Bottom to Top):</em> A - C - E - G <br/>(Mnemonic: <strong>A</strong>ll <strong>C</strong>ows <strong>E</strong>at <strong>G</strong>rass)</p>
                    <p><strong>Accidentals:</strong> Sharp (♯) raises a note by one half step. Flat (♭) lowers a note by one half step. Natural (♮) cancels a previous sharp or flat.</p>
                    <p><strong>Input:</strong> Use keyboard letters C-B. Use Shift + letter for sharps/flats (game accepts this for both). 'm' key follows root for minor chords.</p>
                </div>
            </div>

            <button id="close-guide-btn">Close Guide</button>
        </div>
    </div>

    <script>
        // --- Data Definitions --- (Remain mostly the same)

        // Update notes array to include both representations
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        // Map for enharmonic equivalents (for display purposes)
        const enharmonicMap = {
            "C#": "Db",
            "D#": "Eb",
            "F#": "Gb",
            "G#": "Ab",
            "A#": "Bb"
        };
        // Reverse map for flat to sharp conversion
        const reverseEnharmonicMap = {
            "Db": "C#",
            "Eb": "D#",
            "Gb": "F#",
            "Ab": "G#",
            "Bb": "A#"
        };
        // Function to get a random note with balanced representation
        function getRandomBalancedNote() {
            // 60% chance of natural note, 40% chance of accidental
            const useNatural = Math.random() < 0.6;
            
            if (useNatural) {
                // Get a natural note (indices 0, 2, 4, 5, 7, 9, 11)
                const naturalIndices = [0, 2, 4, 5, 7, 9, 11];
                const randomIndex = Math.floor(Math.random() * naturalIndices.length);
                return notes[naturalIndices[randomIndex]];
            } else {
                // Get a black key note
                const blackKeyIndices = [1, 3, 6, 8, 10];
                const randomIndex = Math.floor(Math.random() * blackKeyIndices.length);
                const note = notes[blackKeyIndices[randomIndex]];
                
                // 50% chance to display as flat instead of sharp
                if (Math.random() < 0.5) {
                    return enharmonicMap[note];
                } else {
                    return note;
                }
            }
        }

        // Chord definitions: using standard spellings where common (like Eb, Ab, Bb)
        // We'll need to map these to abc notation correctly.
        const chords = [
            // Major Triads
            { tones: ["C", "E", "G"], root: "C", quality: "major" },
            { tones: ["C#", "E#", "G#"], root: "C#", quality: "major" }, // E# is F natural
            { tones: ["D", "F#", "A"], root: "D", quality: "major" },
            { tones: ["Eb", "G", "Bb"], root: "Eb", quality: "major" },
            { tones: ["E", "G#", "B"], root: "E", quality: "major" },
            { tones: ["F", "A", "C"], root: "F", quality: "major" },
            { tones: ["F#", "A#", "C#"], root: "F#", quality: "major" },
            { tones: ["G", "B", "D"], root: "G", quality: "major" },
            { tones: ["Ab", "C", "Eb"], root: "Ab", quality: "major" },
            { tones: ["A", "C#", "E"], root: "A", quality: "major" },
            { tones: ["Bb", "D", "F"], root: "Bb", quality: "major" },
            { tones: ["B", "D#", "F#"], root: "B", quality: "major" },

            // Minor Triads
            { tones: ["C", "Eb", "G"], root: "C", quality: "minor" },
            { tones: ["C#", "E", "G#"], root: "C#", quality: "minor" },
            { tones: ["D", "F", "A"], root: "D", quality: "minor" },
            { tones: ["Eb", "Gb", "Bb"], root: "Eb", quality: "minor" }, // Gb is F#
            { tones: ["E", "G", "B"], root: "E", quality: "minor" },
            { tones: ["F", "Ab", "C"], root: "F", quality: "minor" },
            { tones: ["F#", "A", "C#"], root: "F#", quality: "minor" },
            { tones: ["G", "Bb", "D"], root: "G", quality: "minor" },
            { tones: ["Ab", "Cb", "Eb"], root: "Ab", quality: "minor" }, // Cb is B natural
            { tones: ["A", "C", "E"], root: "A", quality: "minor" },
            { tones: ["Bb", "Db", "F"], root: "Bb", quality: "minor" }, // Db is C#
            { tones: ["B", "D", "F#"], root: "B", quality: "minor" },
        ];

        // Add interval definitions
        const intervals = [
            { name: "Perfect Unison", semitones: 0, quality: "P", degree: "1" },
            { name: "Minor 2nd", semitones: 1, quality: "m", degree: "2" },
            { name: "Major 2nd", semitones: 2, quality: "M", degree: "2" },
            { name: "Minor 3rd", semitones: 3, quality: "m", degree: "3" },
            { name: "Major 3rd", semitones: 4, quality: "M", degree: "3" },
            { name: "Perfect 4th", semitones: 5, quality: "P", degree: "4" },
            { name: "Tritone", semitones: 6, quality: "A", degree: "4" },
            { name: "Tritone", semitones: 6, quality: "d", degree: "5" },
            { name: "Perfect 5th", semitones: 7, quality: "P", degree: "5" },
            { name: "Minor 6th", semitones: 8, quality: "m", degree: "6" },
            { name: "Major 6th", semitones: 9, quality: "M", degree: "6" },
            { name: "Minor 7th", semitones: 10, quality: "m", degree: "7" },
            { name: "Major 7th", semitones: 11, quality: "M", degree: "7" },
            { name: "Perfect 8th", semitones: 12, quality: "P", degree: "8" }
        ];
        // Helper function to convert note to abc notation for specific clef
        function noteToAbcForClef(noteName, clef) {
            let abcNote = noteName.charAt(0); // Base note letter (C, D, E...)
            let accidental = "";

            // Handle accidentals
            if (noteName.includes('#')) {
                accidental = "^"; // Sharp
            } else if (noteName.includes('b')) {
                accidental = "_"; // Flat
            } else if (noteName.includes('##')) {
                accidental = "^^"; // Double Sharp
            } else if (noteName.includes('bb')) {
                accidental = "__"; // Double Flat
            }

            // Handle specific enharmonic cases
            if (noteName === "E#") return clef === 'treble' ? "f" : "F,";
            if (noteName === "B#") return clef === 'treble' ? "^c" : "^C,";
            if (noteName === "Fb") return clef === 'treble' ? "e" : "E,";
            if (noteName === "Cb") return clef === 'treble' ? "b" : "B,";

            // Set correct octave based on clef
            if (clef === 'treble') {
                abcNote = abcNote.toLowerCase(); // Middle C octave for treble
            } else {
                abcNote = abcNote.toUpperCase() + ','; // Middle C octave for bass
            }

            return accidental + abcNote;
        }
        // Function to get a random index within an array
        function getRandomIndex(array) {
            return Math.floor(Math.random() * array.length);
        }
        // Function to get a note from index, taking into account enharmonics
        function getNoteFromIndex(index) {
            // Ensure index is within 0-11 range
            index = ((index % 12) + 12) % 12;
            return notes[index];
        }

        // Function to create a grand staff object with blank rests
        function createEmptyGrandStaff() {
            return {
                treble: "z z z z z",
                bass: "z z z z z"
            };
        }

        // --- DOM Elements ---
        const setupGameBtn = document.getElementById('setup-game-btn');
        const setupModal = document.getElementById('setup-modal');
        const beginGameBtn = document.getElementById('begin-game-btn');
        const teacherNameInput = document.getElementById('teacher-name-input');
        const studentNameInput = document.getElementById('student-name-input');
        const staffArea = document.getElementById('staff-area');
        const staffPlaceholder = document.getElementById('staff-placeholder');
        const feedbackArea = document.getElementById('feedback-area');
        const scoreDisplay = document.getElementById('score');
        const startButton = document.getElementById('start-button');
        const pauseButton = document.getElementById('pause-button');
        const pauseOverlay = document.getElementById('pause-overlay');
        const resumeButton = document.getElementById('resume-button');
        const timerBar = document.getElementById('timer-bar');
        const pointsIndicator = document.getElementById('points-indicator');
        const notesBtn = document.getElementById('notes-btn');
        const intervalsBtn = document.getElementById('intervals-btn');
        const chordsBtn = document.getElementById('chords-btn');
        const noteGuideBtn = document.getElementById('note-guide-btn');
        const noteGuideOverlay = document.getElementById('note-guide-overlay');
        const closeGuideBtn = document.getElementById('close-guide-btn');
        const intervalButtons = document.getElementById('interval-buttons');
        const qualityButtons = document.querySelectorAll('.interval-quality-btn');
        const degreeButtons = document.querySelectorAll('.interval-degree-btn');
        const elapsedTimeDisplay = document.getElementById('elapsed-time');
        const teacherNameDisplay = document.getElementById('teacher-name');
        const studentNameDisplay = document.getElementById('student-name');
        const endGameBtn = document.getElementById('end-game-btn');
        const scorecardOverlay = document.getElementById('scorecard-overlay');
        const playAgainBtn = document.getElementById('play-again-btn');
        // Scorecard display elements
        const scorecardTeacher = document.getElementById('scorecard-teacher');
        const scorecardStudent = document.getElementById('scorecard-student');
        const scorecardScore = document.getElementById('scorecard-score');
        const scorecardTime = document.getElementById('scorecard-time');
        const scorecardAccuracy = document.getElementById('scorecard-accuracy');

        // --- Game State Variables ---
        let score = 0;
        let currentItem = null;
        let expectedRootKey = null;
        let isMinorChord = false;
        let gameActive = false;
        let gamePaused = false;
        let gameMode = 'notes';
        let noteStartTime = 0;
        let maxPointsPerQuestion = 1000;
        let timeForMinPoints = 5000;
        let minPointsPerQuestion = 100;
        let timerAnimationId = null;
        const timers = {
            notes: 5000,
            intervals: 12000,
            chords: 7000
        };
        let gameStartTime = 0;
        let elapsedTimeIntervalId = null;
        let teacherName = "Teacher"; // Default, will be set by modal
        let studentName = "Student"; // Default, will be set by modal
        let totalQuestions = 0;
        let correctAnswers = 0;
        // NEW variables for timed modes
        let gameDurationMode = 'practice'; // 'practice', '5min', '10min'
        let gameDurationSeconds = 0; // Total seconds for timed modes
        let challengeTimerId = null; // Interval ID for countdown timer

        // --- Event Listeners ---
        setupGameBtn.addEventListener('click', showSetupModal);
        beginGameBtn.addEventListener('click', processSetupAndStartGame);
        pauseButton.addEventListener('click', togglePause);
        resumeButton.addEventListener('click', togglePause);
        endGameBtn.addEventListener('click', () => endGame(false));
        playAgainBtn.addEventListener('click', () => {
            scorecardOverlay.style.display = 'none';
            showSetupModal();
        });
        noteGuideBtn.addEventListener('click', toggleNoteGuide);
        closeGuideBtn.addEventListener('click', toggleNoteGuide);
        document.addEventListener('keydown', handleKeyPress);
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && gameActive) {
                if (noteGuideOverlay.style.display === 'flex') {
                    toggleNoteGuide();
                } else if (setupModal.style.display === 'flex') {
                    // Optional: Close setup modal on Escape? Or just rely on button?
                    // setupModal.style.display = 'none';
                    // setupGameBtn.style.display = 'inline-block'; 
                    // noteGuideBtn.style.display = 'inline-block';
                } else {
                    togglePause();
                }
            }
        });
        window.addEventListener('beforeunload', () => {
            if (gameActive || challengeTimerId) {
                stopElapsedTimeTimer(); 
            }
        });

        // --- Setup Modal Functions (NEW) ---
        function showSetupModal() {
            // Reset modal fields to defaults
            teacherNameInput.value = "Teacher"; 
            studentNameInput.value = "Student";
            document.getElementById('duration-practice').checked = true;
            
            // Hide game elements, show modal
            setupModal.style.display = 'flex';
            setupGameBtn.style.display = 'none'; 
            noteGuideBtn.style.display = 'none'; 
            pauseButton.style.display = 'none';
            endGameBtn.style.display = 'none';
            if (document.getElementById('timer-container')) {
                document.getElementById('timer-container').style.display = 'none'; // Hide per-question timer
            }
            staffArea.innerHTML = '<div id="staff-placeholder">Setup Game</div>'; // Show placeholder
            if (staffPlaceholder) staffPlaceholder.style.display = 'block';
            feedbackArea.textContent = '\u00A0'; // Clear feedback
        }

        function processSetupAndStartGame() {
            // Get values from modal
            teacherName = teacherNameInput.value.trim() || "Teacher";
            studentName = studentNameInput.value.trim() || "Student";
            gameDurationMode = document.querySelector('input[name="gameDuration"]:checked').value;
            gameMode = document.querySelector('input[name="gameModeSelect"]:checked').value; // Get game mode

            // Set timer duration if applicable
            gameDurationSeconds = 0; // Default to 0 (practice)
            if (gameDurationMode === '5min') {
                gameDurationSeconds = 5 * 60;
            } else if (gameDurationMode === '10min') {
                gameDurationSeconds = 10 * 60;
            }

            // Update displays
            teacherNameDisplay.textContent = teacherName;
            studentNameDisplay.textContent = studentName;
            elapsedTimeDisplay.textContent = '0:00'; // Reset display
            
            // Hide modal
            setupModal.style.display = 'none';
            noteGuideBtn.style.display = 'inline-block'; // Show guide button again

            // Start the actual game logic
            startGame();
        }

        // --- Core Game Functions ---
        function startGame() {
            // --- REMOVED Name Prompting Logic ---

            // Apply mode-specific styles/layouts FIRST
            setGameMode(gameMode); // Call setGameMode with the selected mode

            // --- Start Timers based on mode --- 
            gameStartTime = Date.now();
            stopElapsedTimeTimer(); 
            if (gameDurationSeconds > 0) {
                startChallengeTimer(gameDurationSeconds);
            } else {
                elapsedTimeDisplay.textContent = '0:00';
                startElapsedTimeTimer();
            }

            // --- Reset Score, Stats, etc. --- 
            totalQuestions = 0;
            correctAnswers = 0;
            score = 0;
            updateScoreDisplay();
            feedbackArea.textContent = '';
            feedbackArea.className = '';
            gameActive = true;
            gamePaused = false;
            
            // Update button states
            setupGameBtn.textContent = 'Restart';
            setupGameBtn.style.display = 'inline-block';
            pauseButton.style.display = 'inline-block';
            endGameBtn.style.display = 'inline-block';
            noteGuideBtn.style.display = 'inline-block';
            scorecardOverlay.style.display = 'none';
            pauseOverlay.style.display = 'none';
            
            if (staffPlaceholder) staffPlaceholder.style.display = 'none';
            
            // Reset and show per-question timer elements
            if(document.getElementById('timer-container')) {
                 document.getElementById('timer-container').style.display = 'block';
                 timerBar.style.transform = 'scaleX(1)';
            }
            
            nextItem(); // Start the first question

            // --- Scroll down automatically in Interval mode after starting --- 
            if (gameMode === 'intervals') {
                // Use setTimeout to allow the DOM to update before scrolling
                setTimeout(() => {
                    intervalButtons.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 150); // Slightly longer delay after start
            }
            // --- End Scroll Adjustment ---
        }

        // --- Timer Functions --- 
        function startElapsedTimeTimer() {
            // Function content remains the same (updates elapsedTimeDisplay)
            if (elapsedTimeIntervalId) {
                clearInterval(elapsedTimeIntervalId);
            }
            function updateDisplay() {
                if (gamePaused || !gameActive) return; // Also check gameActive
                const now = Date.now();
                const elapsedSeconds = Math.floor((now - gameStartTime) / 1000);
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                elapsedTimeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            updateDisplay();
            elapsedTimeIntervalId = setInterval(updateDisplay, 1000);
        }

        // CHANGE: stopElapsedTimeTimer stops BOTH timers
        function stopElapsedTimeTimer() {
            if (elapsedTimeIntervalId) {
                clearInterval(elapsedTimeIntervalId);
                elapsedTimeIntervalId = null;
            }
            if (challengeTimerId) {
                clearInterval(challengeTimerId);
                challengeTimerId = null;
            }
        }

        // NEW: Challenge Countdown Timer
        function startChallengeTimer(durationInSeconds) {
            let remainingTime = durationInSeconds;
            // We update the existing elapsedTimeDisplay for countdown
            elapsedTimeDisplay.classList.add('challenge-timer'); // Optional: Add class for styling

            function updateChallengeDisplay() {
                if (gamePaused || !gameActive) return; 
                
                remainingTime--;
                
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                elapsedTimeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} ⏳`; // Countdown icon

                if (remainingTime <= 0) {
                    clearInterval(challengeTimerId);
                    challengeTimerId = null;
                    elapsedTimeDisplay.textContent = "Time's Up!";
                    elapsedTimeDisplay.classList.remove('challenge-timer');
                    endGame(true); // Automatically end the game when time is up (pass true)
                }
            }
            // Clear previous timer if any
            if (challengeTimerId) clearInterval(challengeTimerId);
            updateChallengeDisplay(); // Initial display
            challengeTimerId = setInterval(updateChallengeDisplay, 1000);
        }

        // --- Game Over Function (Modified) ---
        function endGame(timeExpired = false) { // Accept optional parameter
            // Prevent multiple calls if game already ended
            if (!gameActive && !timeExpired) { // Allow call if timeExpired even if gameActive false
                // If manually ended and already inactive, do nothing
                return; 
            } 
            // If time expired, ensure gameActive is false
            if (timeExpired) gameActive = false; 
            
            gameActive = false; // Set explicitly
            gamePaused = true; // Effectively pause things
            
            stopElapsedTimeTimer(); // Stops both timers now
            
            // Stop per-question timer animation if running
            if (timerAnimationId) {
                cancelAnimationFrame(timerAnimationId);
                timerAnimationId = null;
            }
            
            // Hide game controls
            pauseButton.style.display = 'none';
            endGameBtn.style.display = 'none';
            noteGuideBtn.style.display = 'none'; 
            if(document.getElementById('timer-container')) {
                document.getElementById('timer-container').style.display = 'none';
            }

            // Calculate stats
            const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            
            // Determine final time display based on mode
            let finalTime = "N/A";
            if (gameDurationSeconds > 0) {
                // Timed mode: Show the duration limit
                const minutes = Math.floor(gameDurationSeconds / 60);
                finalTime = `${minutes}:00 Challenge`;
                if (timeExpired) finalTime += " (Time's Up!)";
            } else {
                // Practice mode: Show final elapsed time
                const finalElapsedSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
                const minutes = Math.floor(finalElapsedSeconds / 60);
                const seconds = finalElapsedSeconds % 60;
                finalTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            const finalScore = scoreDisplay.textContent; // Get score from display
            
            // Populate scorecard
            document.getElementById('scorecard-title').textContent = `Congratulations ${studentName}!`; // Update title
            scorecardTeacher.textContent = teacherName;
            scorecardStudent.textContent = studentName;
            scorecardScore.textContent = finalScore;
            scorecardTime.textContent = finalTime; 
            scorecardAccuracy.textContent = `${accuracy}% (${correctAnswers}/${totalQuestions})`;
            
            // Display scorecard & reset setup button
            scorecardOverlay.style.display = 'flex';
            setupGameBtn.textContent = 'Launch New Game'; // Reset button text
            setupGameBtn.style.display = 'inline-block'; // Show setup button again
        }

        // --- Other Functions ---

        // Modified togglePause to ensure buttons are handled correctly
        function togglePause() {
            // Allow pause only if game is active OR challenge timer is running (even if game ended)
            if (!gameActive && !challengeTimerId) return; 
            
            gamePaused = !gamePaused;
            
            if (gamePaused) {
                pauseButton.style.display = 'none';
                endGameBtn.style.display = 'none'; 
                pauseOverlay.style.display = 'flex';
                // Timers pause via their internal checks
            } else { // Resuming
                pauseButton.style.display = 'inline-block';
                endGameBtn.style.display = 'inline-block';
                pauseOverlay.style.display = 'none';
                // Resume per-question timer animation if needed
                if (currentItem) {
                    updateTimingIndicator(Date.now() - noteStartTime);
                }
                // Other timers resume via their internal checks
            }
        }

        // ... (rest of functions like nextItem, correctAnswer, incorrectAnswer, setGameMode, etc. should be mostly unchanged unless they interact with timers/game state in a way not covered)

        // --- abcjs Notation Helper ---

        /**
         * Converts a note name (e.g., "C#", "Eb", "G") into abc notation format.
         * Handles accidentals and basic octave placement (relative to middle C).
         * @param {string} noteName - The name of the note.
         * @returns {string} The note in abc notation (e.g., "^C", "_E", "G").
         */
        function noteToAbc(noteName) {
            let abcNote = noteName.charAt(0); // Base note letter (C, D, E...)
            let accidental = "";

            // Handle accidentals
            if (noteName.includes('#')) {
                accidental = "^"; // Sharp
            } else if (noteName.includes('b')) {
                accidental = "_"; // Flat
            } else if (noteName.includes('##')) {
                accidental = "^^"; // Double Sharp - abcjs might need specific handling or fonts
            } else if (noteName.includes('bb')) {
                accidental = "__"; // Double Flat - abcjs might need specific handling or fonts
            }

            // Handle specific enharmonic cases if needed (e.g., E# -> F, Cb -> B)
            // These need to be handled before lowercase conversion
            if (noteName === "E#") return currentClef === 'treble' ? "f" : "F,";  // E# is the same as F
            if (noteName === "B#") return currentClef === 'treble' ? "^c" : "^C,"; // B# is the same as C#
            if (noteName === "Fb") return currentClef === 'treble' ? "e" : "E,";  // Fb is the same as E
            if (noteName === "Cb") return currentClef === 'treble' ? "b" : "B,";  // Cb is the same as B

            // In ABC notation: 
            // - Treble clef: lowercase letters (c,d,e,f,g,a,b) = middle C octave
            // - Bass clef: uppercase letters with comma (C,D,E,F,G,A,B,) = middle C octave
            if (currentClef === 'treble') {
                // For treble clef, use lowercase for middle C octave
                abcNote = abcNote.toLowerCase();
             } else {
                // For bass clef, use uppercase with comma for middle C octave
                abcNote = abcNote.toUpperCase() + ',';
             }

            // Construct the abc note string
            return accidental + abcNote;
        }

        function renderStaff(abcString) {
            // Basic abc header with a grand staff (both treble and bass clefs)
            const header = "X:1\nM:4/4\nL:1/4\nK:clef=treble\nV:1 clef=treble\nV:2 clef=bass\n";
            
            // Format to show both treble and bass clefs in grand staff
            // The [V:1] and [V:2] markers indicate which voice/staff is being used
            let fullAbc = header + "[V:1] " + abcString.treble + " |]\n";
            fullAbc += "[V:2] " + abcString.bass + " |]";
            
            // Debug: Log the ABC notation
            console.log("Full ABC notation (Grand Staff):", fullAbc);

            // Use abcjs to render
            // Ensure the target div is empty before rendering
            staffArea.innerHTML = '';
            try {
            ABCJS.renderAbc(staffArea, fullAbc, {
                    scale: 1.6,
                    staffwidth: 400,
                paddingtop: 0,
                paddingbottom: 0,
                paddingleft: 0,
                paddingright: 0,
                    responsive: "resize",
                    add_classes: true,
                    // Hide elements we don't need for flashcards
                    hideFingerlings: true,
                    hideStemDetails: false,
                    hideTimeSignature: true
                });
                
                // Apply Piano Ninja styling to the SVG elements after rendering
                const svgElements = staffArea.querySelectorAll('svg');
                svgElements.forEach(svg => {
                    // Set SVG to fill its container properly
                    svg.style.display = 'block';
                    svg.style.margin = '0 auto';
                    
                    // Add subtle glow effect to the SVG
                    svg.style.filter = 'drop-shadow(0 0 1px rgba(0, 255, 0, 0.3))';
                    
                    // Make staff lines green but more visible
                    const staffLines = svg.querySelectorAll('path.abcjs-staff');
                    staffLines.forEach(line => {
                        line.setAttribute('stroke', '#3dff3d');
                        line.setAttribute('stroke-opacity', '1.0');
                        line.setAttribute('stroke-width', '1.5'); // Increase line width for better visibility
                    });
                    
                    // Make notes green with subtle glow
                    const noteHeads = svg.querySelectorAll('g.abcjs-note path, path.abcjs-stem');
                    noteHeads.forEach(note => {
                        note.setAttribute('fill', '#3dff3d');
                        note.setAttribute('stroke', '#3dff3d');
                        note.setAttribute('stroke-width', '1.1');
                    });
                    
                    // Make note circles glow subtly
                    const noteCircles = svg.querySelectorAll('ellipse');
                    noteCircles.forEach(circle => {
                        circle.setAttribute('fill', '#3dff3d');
                        circle.setAttribute('stroke', '#3dff3d');
                        circle.style.filter = 'drop-shadow(0 0 1px rgba(0, 255, 0, 0.5))';
                    });
                    
                    // Add very subtle glow to other musical elements
                    const musicElements = svg.querySelectorAll('.abcjs-clef, .abcjs-note, .abcjs-rest');
                    musicElements.forEach(el => {
                        el.style.filter = 'drop-shadow(0 0 1px rgba(0, 255, 0, 0.4))';
                    });
                    
                    // Ensure clefs are clearly visible
                    const clefs = svg.querySelectorAll('.abcjs-clef');
                    clefs.forEach(clef => {
                        clef.setAttribute('stroke-width', '1.2');
                    });
                });
            } catch (error) {
                console.error("Error rendering ABC notation:", error);
                staffArea.innerHTML = '<div style="color:#0f0; text-shadow: 0 0 5px #0f0;">Error rendering staff</div>';
            }
        }

        // Helper function to determine number of interval options based on score
        function getIntervalOptionsCount(score) {
            // Progressive difficulty based on score
            if (score < 2000) {
                return 2; // Start with 2 options (1 correct, 1 incorrect)
            } else if (score < 4000) {
                return 3; // 3 options when score is 2000-3999
            } else if (score < 6000) {
                return 4; // 4 options when score is 4000-5999
            } else {
                return 5; // Max of 5 options when score is 6000+
            }
        }

        function nextItem() {
            if (!gameActive) return;
            
            totalQuestions++; // Increment total questions when a new item is presented

            listeningForMinorKey = false;
            feedbackArea.textContent = '\u00A0';
            feedbackArea.className = '';

            // Reset interval button selections if in interval mode
            if (gameMode === 'intervals') {
                resetIntervalButtonSelections();
            }

            // Create object to hold grand staff notation
            let abcToRender = createEmptyGrandStaff();
            
            // Generate content based on game mode
            if (gameMode === 'notes') {
                // Randomly decide if the note goes on treble or bass clef
                const useTreebleClef = Math.random() > 0.5;
                
                // Get a random note with balanced distribution
                const randomNote = getRandomBalancedNote();
                
                // Create note representation for the selected clef
                if (useTreebleClef) {
                    abcToRender.treble = "z z " + noteToAbcForClef(randomNote, 'treble') + " z z";
                    abcToRender.bass = "z z z z z";
                expectedRootKey = randomNote.charAt(0).toLowerCase();
                } else {
                    abcToRender.treble = "z z z z z";
                    abcToRender.bass = "z z " + noteToAbcForClef(randomNote, 'bass') + " z z";
                    expectedRootKey = randomNote.charAt(0).toLowerCase();
                }
                
                // Update current item
                currentItem = { 
                    type: 'note', 
                    value: randomNote,
                    clef: useTreebleClef ? 'treble' : 'bass',
                    abcString: abcToRender
                };
                
                isMinorChord = false;
                console.log(`Next: Note ${randomNote} on ${currentItem.clef} clef, Expect: ${expectedRootKey}`);
                
            } else if (gameMode === 'intervals') {
                // COMPLETELY SIMPLIFIED APPROACH FOR RELIABLE INTERVAL IDENTIFICATION
                
                // 1. Define the possible intervals we want to show
                const simpleIntervals = [
                    { name: "Perfect Unison", semitones: 0, positions: 0 },
                    { name: "Minor 2nd", semitones: 1, positions: 1 },
                    { name: "Major 2nd", semitones: 2, positions: 1 },
                    { name: "Minor 3rd", semitones: 3, positions: 2 },
                    { name: "Major 3rd", semitones: 4, positions: 2 },
                    { name: "Perfect 4th", semitones: 5, positions: 3 },
                    { name: "Tritone", semitones: 6, positions: 3 },  // As augmented 4th
                    { name: "Tritone", semitones: 6, positions: 4 },  // As diminished 5th
                    { name: "Perfect 5th", semitones: 7, positions: 4 },
                    { name: "Minor 6th", semitones: 8, positions: 5 },
                    { name: "Major 6th", semitones: 9, positions: 5 },
                    { name: "Minor 7th", semitones: 10, positions: 6 },
                    { name: "Major 7th", semitones: 11, positions: 6 },
                    { name: "Perfect 8th", semitones: 12, positions: 7 }
                ];

                // 2. Pick a random interval from our list
                const selectedInterval = simpleIntervals[Math.floor(Math.random() * simpleIntervals.length)];
                console.log("Selected interval:", selectedInterval.name);
                
                // 3. Use fixed notes for consistency based on position count
                // This defines exactly what should be displayed on the staff
                // The position count in the interval definition corresponds to these patterns
                const intervalPatterns = [
                    // positions: 0 (unison)
                    { lower: "C4", upper: "C4", lowerAbc: "c", upperAbc: "c" },
                    // positions: 1 (2nds) 
                    { lower: "C4", upper: "D4", lowerAbc: "c", upperAbc: "d" },
                    // positions: 2 (3rds)
                    { lower: "C4", upper: "E4", lowerAbc: "c", upperAbc: "e" },
                    // positions: 3 (4ths)
                    { lower: "C4", upper: "F4", lowerAbc: "c", upperAbc: "f" },
                    // positions: 4 (5ths)
                    { lower: "C4", upper: "G4", lowerAbc: "c", upperAbc: "g" },
                    // positions: 5 (6ths)
                    { lower: "C4", upper: "A4", lowerAbc: "c", upperAbc: "a" },
                    // positions: 6 (7ths)
                    { lower: "C4", upper: "B4", lowerAbc: "c", upperAbc: "b" },
                    // positions: 7 (octave)
                    { lower: "C4", upper: "C5", lowerAbc: "c", upperAbc: "c'" }
                ];
                
                // 4. Get the base pattern for our selected interval
                const pattern = intervalPatterns[selectedInterval.positions];
                
                // 5. Apply any needed accidental to the upper note based on semitones
                // Default pattern is based on C major scale, so we need to adjust
                const naturalSemitones = [0, 2, 4, 5, 7, 9, 11, 12]; // C major scale semitones
                const targetSemitones = selectedInterval.semitones;
                const adjustmentNeeded = targetSemitones - naturalSemitones[selectedInterval.positions];
                
                let upperAccidental = "";
                let abcAccidental = "";
                
                if (adjustmentNeeded === 1) {
                    upperAccidental = "#";
                    abcAccidental = "^";
                } else if (adjustmentNeeded === -1) {
                    upperAccidental = "b";
                    abcAccidental = "_";
                } else if (adjustmentNeeded === 2) {
                    upperAccidental = "##";
                    abcAccidental = "^^";
                } else if (adjustmentNeeded === -2) {
                    upperAccidental = "bb";
                    abcAccidental = "__";
                }
                
                // 6. Create our actual displayed notes
                const lowerNote = pattern.lower;
                const upperNote = pattern.upper.replace(/[A-G]/, "$&" + upperAccidental);
                
                // 7. Create ABC notation
                const lowerAbc = pattern.lowerAbc;
                const upperAbc = abcAccidental + pattern.upperAbc;
                
                // Random pick if we'll show on treble or bass clef
                const useTreebleClef = Math.random() > 0.5;
                
                // 8. Build the staff notation
                if (useTreebleClef) {
                    abcToRender.treble = `z ${lowerAbc} ${upperAbc} z`;
                    abcToRender.bass = "z z z z";
                } else {
                    // For bass clef, we need to use uppercase and add commas for register
                    const bassLowerAbc = lowerAbc.toUpperCase() + ",";
                    const bassUpperAbc = abcAccidental + pattern.upperAbc.toUpperCase() + 
                                        (pattern.upperAbc === "c'" ? "" : ",");
                    
                    abcToRender.treble = "z z z z";
                    abcToRender.bass = `z ${bassLowerAbc} ${bassUpperAbc} z`;
                }
                
                // 9. Create our current interval object
                const intervalObj = {
                    name: selectedInterval.name,
                    semitones: selectedInterval.semitones,
                    positions: selectedInterval.positions,
                    lowerNote: lowerNote,
                    upperNote: upperNote
                };
                
                // 10. Determine the number of options based on player's score - UPDATED
                const numberOfOptions = getIntervalOptionsCount(score);
                
                // 11. Generate answer options (1 correct + variable number of incorrect)
                const intervalOptions = generateIntervalOptions(intervalObj, numberOfOptions);
                
                // 12. Store everything in the current item
                currentItem = {
                    type: 'interval',
                    value: intervalObj,
                    abcString: abcToRender,
                    options: intervalOptions,
                    selectedAnswer: null,
                    displayMode: useTreebleClef ? 'treble' : 'bass',
                    difficulty: numberOfOptions // Track the difficulty level
                };
                
                // 13. Generate the choice buttons
                generateIntervalChoiceButtons(intervalOptions, selectedInterval.name);

                // 14. Set feedback prompt for interval mode - without difficulty announcement
                showFeedback("Select the interval", "intermediate"); 
                
                // 15. Debug output - keep for debugging but not visible to user
                console.log(`Interval: ${selectedInterval.name}, From ${lowerNote} to ${upperNote}, ` +
                           `Semitones: ${selectedInterval.semitones}, Positions: ${selectedInterval.positions}, ` +
                           `Difficulty: ${numberOfOptions} options`);
            } else { // chords or notes mode
                // Get a random chord
                let randomChord = { ...chords[getRandomIndex(chords)] };
                
                // Balance major/minor triads with flats and sharps by randomly converting some chords
                // to their enharmonic equivalents
                if (randomChord.quality === 'major' && enharmonicMap[randomChord.root] && Math.random() < 0.5) {
                    // Convert to flat version
                    const flatRoot = enharmonicMap[randomChord.root];
                    randomChord = chords.find(chord => chord.root === flatRoot && chord.quality === 'major') || randomChord;
                } else if (randomChord.quality === 'minor' && enharmonicMap[randomChord.root] && Math.random() < 0.5) {
                    // Convert to flat version
                    const flatRoot = enharmonicMap[randomChord.root];
                    randomChord = chords.find(chord => chord.root === flatRoot && chord.quality === 'minor') || randomChord;
                }
                
                // Decide where to place the chord (treble, bass, or across both)
                const chordPlacement = Math.random() < 0.6 ? 'treble' : 
                                    Math.random() < 0.8 ? 'bass' : 'across';
                
                // Convert chord tones to abc notation for the respective clefs
                if (chordPlacement === 'treble') {
                    // All notes on treble clef
                    const trebleChordTones = randomChord.tones.map(note => noteToAbcForClef(note, 'treble'));
                    abcToRender.treble = "z z [" + trebleChordTones.join("") + "] z z";
                    abcToRender.bass = "z z z z z";
                } else if (chordPlacement === 'bass') {
                    // All notes on bass clef
                    const bassChordTones = randomChord.tones.map(note => noteToAbcForClef(note, 'bass'));
                    abcToRender.treble = "z z z z z";
                    abcToRender.bass = "z z [" + bassChordTones.join("") + "] z z";
                } else {
                    // Split chord across both clefs (e.g., root in bass, 3rd and 5th in treble)
                    const bassNote = noteToAbcForClef(randomChord.tones[0], 'bass');
                    const trebleNotes = [
                        noteToAbcForClef(randomChord.tones[1], 'treble'),
                        noteToAbcForClef(randomChord.tones[2], 'treble')
                    ];
                    
                    abcToRender.treble = "z z [" + trebleNotes.join("") + "] z z";
                    abcToRender.bass = "z z " + bassNote + " z z";
                }
                
                // Update current item
                currentItem = {
                    type: 'chord',
                    value: randomChord,
                    placement: chordPlacement,
                    abcString: abcToRender
                };
                
                expectedRootKey = randomChord.root.charAt(0).toLowerCase();
                isMinorChord = randomChord.quality === 'minor';

                console.log(`Next: Chord ${randomChord.root} ${randomChord.quality} on ${chordPlacement}, ` +
                          `Expect: ${expectedRootKey}${isMinorChord ? ' then m' : ''}`);
            }

             // Render the generated abc notation to the staff
             renderStaff(abcToRender);
            
            // Start the timer for this question
            noteStartTime = Date.now();
            
            // Show timing indicator
            updateTimingIndicator();
        }

        // Calculate points based on elapsed time
        function calculatePoints(elapsedTime) {
            if (elapsedTime >= timeForMinPoints) {
                return minPointsPerQuestion;
            }
            
            // Linear scale from max points to min points
            const pointsLost = (maxPointsPerQuestion - minPointsPerQuestion) * (elapsedTime / timeForMinPoints);
            const points = Math.floor(maxPointsPerQuestion - pointsLost);
            return Math.max(points, minPointsPerQuestion);
        }
        // Update the timer bar and points indicator
        function updateTimingIndicator(elapsedMsOverride = 0) {
            // Clear any existing timer
            if (timerAnimationId) {
                cancelAnimationFrame(timerAnimationId);
                timerAnimationId = null;
            }
            
            // Reset timer bar
            timerBar.style.transform = 'scaleX(1)';
            pointsIndicator.textContent = `+${maxPointsPerQuestion}`;
            
            // If game is paused, don't start a new timer
            if (gamePaused) return;
            
            // Start the animation
            const startTime = Date.now() - elapsedMsOverride;
            
            function animate() {
                if (!gameActive || gamePaused) {
                    if (timerAnimationId) {
                        cancelAnimationFrame(timerAnimationId);
                        timerAnimationId = null;
                    }
                    return;
                }
                
                const elapsed = Date.now() - startTime;
                
                if (elapsed >= timeForMinPoints) {
                    // Timer completed
                    timerBar.style.transform = 'scaleX(0)';
                    pointsIndicator.textContent = `+${minPointsPerQuestion}`;
                    
                    if (timerAnimationId) {
                        cancelAnimationFrame(timerAnimationId);
                        timerAnimationId = null;
                    }
                    return;
                }
                
                // Calculate scale based on elapsed time (0 to 1)
                const scale = Math.max(0, 1 - (elapsed / timeForMinPoints));
                timerBar.style.transform = `scaleX(${scale})`;
                
                // Update points indicator
                const currentPoints = calculatePoints(elapsed);
                pointsIndicator.textContent = `+${currentPoints}`;
                
                // Continue animation
                timerAnimationId = requestAnimationFrame(animate);
            }
            
            // Start animation loop
            timerAnimationId = requestAnimationFrame(animate);
        }
        // Show the points earned animation
        function showPointsEarned(points, x, y) {
            const pointsPopup = document.createElement('div');
            pointsPopup.className = 'points-popup';
            pointsPopup.textContent = `+${points}`;
            pointsPopup.style.left = `${x}px`;
            pointsPopup.style.top = `${y}px`;
            document.body.appendChild(pointsPopup);
            
            // Remove after animation completes
            setTimeout(() => {
                document.body.removeChild(pointsPopup);
            }, 1200);
        }

        // handleKeyPress, correctAnswer, incorrectAnswer, showFeedback, updateScoreDisplay
        // functions remain exactly the same as the previous text-based version.
        // They handle the logic of checking key presses against expectedRootKey and isMinorChord.

        function handleKeyPress(event) {
            if (!gameActive || gamePaused) return;

            const pressedKey = event.key.toLowerCase();
            const isShift = event.shiftKey;
            // const isAlt = event.altKey; // No longer needed

            console.log(`Key pressed: ${pressedKey}, Shift: ${isShift}, Game mode: ${gameMode}, Type: ${currentItem ? currentItem.type : 'none'}`);

            // Only process note/chord input here (a-g)
            if (!(pressedKey >= 'a' && pressedKey <= 'g')) {
                if (currentItem && currentItem.type === 'interval') {
                   // Interval logic handled elsewhere
                } else {
                    console.log("Ignoring non-note key.");
                }
                    return;
                }

            // Exit if not note or chord mode
            if (!currentItem || (currentItem.type !== 'note' && currentItem.type !== 'chord')) {
                console.log("Ignoring note input outside note/chord mode.");
                return;
            }

            // --- Determine Expected Note/Chord Root --- 
            let expectedValueString = "";
            let expectedNoteLetter = "";
            let requiresAccidental = false;
            // let expectedIsMinor = false; // No longer needed

            if (currentItem.type === 'note') {
                expectedValueString = currentItem.value;
            } else if (currentItem.type === 'chord') {
                expectedValueString = currentItem.value.root;
                // expectedIsMinor = currentItem.value.quality === 'minor'; // Don't need quality anymore
                } else {
                console.error("Invalid current item type."); return;
            }

            if (!expectedValueString) {
                 console.error("Expected value string is empty."); return;
            }
            
            expectedNoteLetter = expectedValueString.charAt(0).toLowerCase();
            // Treat flats and sharps the same regarding accidental requirement
            requiresAccidental = expectedValueString.includes('#') || expectedValueString.includes('b'); 

            console.log(`Expected Root: ${expectedValueString}, Letter: ${expectedNoteLetter}, Accidental?: ${requiresAccidental}`);

            // --- Validate User Input (Root Note Only) --- 
            let letterMatch = (pressedKey === expectedNoteLetter);
            // Shift key must be pressed IFF an accidental is required
            let accidentalMatch = (isShift === requiresAccidental); 
            // let qualityMatch = (isAlt === expectedIsMinor); // No longer check quality

            // Check if the root note input is correct (letter + accidental handling)
            const userInputCorrect = letterMatch && accidentalMatch;

            // --- Provide Specific Feedback for Mismatches --- 
            if (!userInputCorrect && letterMatch) { // Letter was right, check accidental modifier
                if (!accidentalMatch) {
                    // Accidental mismatch (Shift key usage wrong)
                    incorrectAnswer(`Incorrect. Use Shift key ${requiresAccidental ? 'for' : 'without'} accidental on root '${expectedValueString}'.`);
                    return;
                }
                // No other modifier checks needed
            }
            
            // --- Process Result --- 
            if (userInputCorrect) {
                 console.log("User input judged as CORRECT (root note).");
                 correctAnswer(event); // Correct root identified
            } else {
                 console.log("User input judged as INCORRECT (root note).");
                 // Generic incorrect message if a specific one wasn't shown above
                 const expectedDisplay = `${expectedValueString}`; // Just show the root note
                 incorrectAnswer(`Incorrect. Expected root '${expectedDisplay}'.`);
            }
        }

        function correctAnswer(event) {
            correctAnswers++; // Increment correct answers
            // Stop the timer animation
            if (timerAnimationId) {
                cancelAnimationFrame(timerAnimationId);
                timerAnimationId = null;
            }
            
            // Calculate elapsed time and points
            const elapsedTime = Date.now() - noteStartTime;
            const pointsEarned = calculatePoints(elapsedTime);
            
            // Keep track of difficulty before scoring (silently)
            let prevDifficulty = 0;
            if (gameMode === 'intervals') {
                prevDifficulty = getIntervalOptionsCount(score);
            }
            
            // Add to score
            score += pointsEarned;
            updateScoreDisplay();
            
            // Check if difficulty changed (silently)
            let difficultyChanged = false;
            if (gameMode === 'intervals') {
                const newDifficulty = getIntervalOptionsCount(score);
                difficultyChanged = (newDifficulty > prevDifficulty);
            }
            
            // Simple feedback without difficulty announcement
            showFeedback('Correct!', 'correct');
            
            // Show points animation near the mouse position or keyboard
            const x = event && event.clientX ? event.clientX : window.innerWidth / 2;
            const y = event && event.clientY ? event.clientY : window.innerHeight / 2;
            showPointsEarned(pointsEarned, x - 20, y - 30);
            
            // Move to next item after delay (slightly longer delay if difficulty changed)
            setTimeout(nextItem, difficultyChanged ? 1200 : 800);
        }

        function incorrectAnswer(message) {
            // Stop the timer animation
            if (timerAnimationId) {
                cancelAnimationFrame(timerAnimationId);
                timerAnimationId = null;
            }
            
            // Optional: Keep the current staff visible longer on incorrect answer
            showFeedback(message, 'incorrect');
            setTimeout(nextItem, 1500); // Slightly longer delay
        }

        function showFeedback(message, type = 'success') {
            feedbackArea.textContent = message;
            feedbackArea.className = type;
        }

        function updateScoreDisplay() {
            // Format the score with leading zeros
            const formattedScore = String(score).padStart(6, '0');
            scoreDisplay.textContent = formattedScore;
        }

        // Function to toggle pause state
        function togglePause() {
            if (!gameActive) return;
            
            
            gamePaused = !gamePaused;
            
            if (gamePaused) {
                // Pause the game
                pauseButton.style.display = 'none';
                endGameBtn.style.display = 'none'; // Hide End Game btn while paused
                pauseOverlay.style.display = 'flex';
            } else {
                // Resume the game
                pauseButton.style.display = 'inline-block';
                endGameBtn.style.display = 'inline-block'; // Show End Game btn again
                pauseOverlay.style.display = 'none';
                
                // If the timer was running, restart it from current position
                if (currentItem) {
                    updateTimingIndicator(Date.now() - noteStartTime);
                }
            }
        }

        // Function to set the active game mode
        function setGameMode(mode) {
            // If mode hasn't changed, do nothing (might be called by startGame)
            // Note: gameMode global variable is already set in processSetupAndStartGame
            // This function now primarily applies UI changes based on the mode.
            
            console.log(`Setting UI for game mode: ${mode}`);

            // --- Dynamic Staff Area Adjustment --- 
            if (mode === 'intervals') {
                intervalButtons.style.display = 'flex'; // Show interval buttons
                resetIntervalButtonSelections(); 
                // Apply compact styles for interval mode
                staffArea.style.minHeight = '120px'; 
                staffArea.style.padding = '10px 15px 20px 15px'; 
            } else {
                // Apply default/larger styles for notes/chords mode
                intervalButtons.style.display = 'none'; // Hide interval buttons
                staffArea.style.minHeight = '180px'; // Restore larger height
                staffArea.style.padding = '10px 15px 60px 15px'; // Restore larger padding
            }
            // --- End Dynamic Adjustment ---
            
            // Update the timer duration variable (used by per-question timer)
            timeForMinPoints = timers[mode];

            // NOTE: We don't call nextItem() here anymore because startGame does it
            // after calling this function.
        }

        // Function to toggle note guide
        function toggleNoteGuide() {
            if (noteGuideOverlay.style.display === 'flex') {
                // Close the guide
                noteGuideOverlay.style.display = 'none';
                // If game was active and paused by guide, resume it
                if (gameActive && gamePaused && pauseOverlay.style.display === 'none') {
                    gamePaused = false;
                    if (currentItem) {
                        updateTimingIndicator(Date.now() - noteStartTime);
                    }
                }
            } else {
                // Open the guide
                noteGuideOverlay.style.display = 'flex';
                // If game is active, pause it
                if (gameActive && !gamePaused) {
                    gamePaused = true;
                    // Don't show pause overlay though
                }
            }
        }

        // Add event listeners to the keys / buttons
        document.addEventListener('keydown', handleKeyPress);
        document.querySelectorAll('.keyboard-key').forEach(key => {
            key.addEventListener('click', handleKeyClick);
        });
        
        // Function to show a success message
        function showSuccessMessage(message) {
            showFeedback(message, 'correct');
        }
        
        // Function to show a failure message
        function showFailMessage(message) {
            showFeedback(message, 'incorrect');
        }
        
        // Function to clear any displayed messages
        function clearMessage() {
            feedbackArea.textContent = '';
            feedbackArea.className = '';
        }
        
        // Function to generate a new note/interval/chord
        function generateNewNote() {
            nextItem();
        }
        
        // Setup interval quality buttons
        qualityButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (!gameActive || gamePaused || !currentItem || currentItem.type !== 'interval') return;
                
                // Reset all quality buttons
                qualityButtons.forEach(btn => btn.classList.remove('selected'));
                
                // Select this button
                this.classList.add('selected');
                
                // Store the selected quality
                const quality = this.getAttribute('data-quality');
                currentItem.selectedQuality = quality;
                
                // Check if we have both parts selected
                checkIntervalSelection();
            });
        });

        // Setup interval degree buttons
        degreeButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (!gameActive || gamePaused || !currentItem || currentItem.type !== 'interval') return;
                
                // Reset all degree buttons
                degreeButtons.forEach(btn => btn.classList.remove('selected'));
                
                // Select this button
                this.classList.add('selected');
                
                // Store the selected degree
                const degree = this.getAttribute('data-degree');
                currentItem.selectedDegree = degree;
                
                // Check if we have both parts selected
                checkIntervalSelection();
            });
        });

        // Function to check if interval selection is complete
        function checkIntervalSelection() {
            if (currentItem.selectedQuality && currentItem.selectedDegree) {
                // We have both quality and degree, check answer
                const userInterval = currentItem.selectedQuality + currentItem.selectedDegree;
                const correctInterval = currentItem.value.quality + currentItem.value.degree;
                
                // Clear feedback area immediately
                feedbackArea.textContent = '';
                
                // Case-insensitive comparison for interval quality
                if (userInterval.toLowerCase() === correctInterval.toLowerCase()) {
                    correctAnswer(null); // No event since it's a button click
                } else {
                    incorrectAnswer(`Incorrect. The interval was ${currentItem.value.name} (${correctInterval}).`);
                }
                
                // Reset selections for next interval
                resetIntervalButtonSelections();
            }
        }

        // Function to reset interval button selections
        function resetIntervalButtonSelections() {
            qualityButtons.forEach(btn => btn.classList.remove('selected'));
            degreeButtons.forEach(btn => btn.classList.remove('selected'));
            
            // Fix for tritone button
            const tritoneBtn = document.querySelector('.interval-special-btn[data-interval="tritone"]');
            if (tritoneBtn) tritoneBtn.classList.remove('selected');
            
            if (currentItem) {
                currentItem.selectedQuality = null;
                currentItem.selectedDegree = null;
            }
        }

        // Setup tritone special button
        document.addEventListener('DOMContentLoaded', function() {
            const tritoneButton = document.querySelector('.interval-special-btn[data-interval="tritone"]');
            if (tritoneButton) {
                tritoneButton.addEventListener('click', function() {
                    if (!gameActive || gamePaused || !currentItem || currentItem.type !== 'interval') return;
                    
                    // Reset all buttons
                    qualityButtons.forEach(btn => btn.classList.remove('selected'));
                    degreeButtons.forEach(btn => btn.classList.remove('selected'));
                    
                    // Select this special button
                    this.classList.add('selected');
                    
                    // For tritone, we'll randomly select either A4 or d5
                    // This matches how the interval is generated in the nextItem function
                    const isTritone = currentItem.value.semitones === 6;
                    
                    if (isTritone) {
                        // Check if the actual interval is A4 or d5
                        if (currentItem.value.quality === 'A' && currentItem.value.degree === '4') {
                            currentItem.selectedQuality = 'A';
                            currentItem.selectedDegree = '4';
                            correctAnswer(null);
                        } else if (currentItem.value.quality === 'd' && currentItem.value.degree === '5') {
                            currentItem.selectedQuality = 'd';
                            currentItem.selectedDegree = '5';
                            correctAnswer(null);
                        } else {
                            incorrectAnswer(`Incorrect. The interval was ${currentItem.value.name} (${currentItem.value.quality}${currentItem.value.degree}).`);
                        }
                    } else {
                        incorrectAnswer(`Incorrect. The interval was ${currentItem.value.name} (${currentItem.value.quality}${currentItem.value.degree}).`);
                    }
                    
                    // Reset selection after a short delay
                    setTimeout(() => {
                        this.classList.remove('selected');
                    }, 800);
                });
            }
        });

        // Handle clicking on an interval button
        function handleIntervalButton(event) {
            if (!currentItem || currentItem.type !== 'interval') return;
            
            let target = event.target;
            
            // If we clicked on the span inside the button, use the parent button
            if (target.tagName === 'SPAN') {
                target = target.parentElement;
            }
            
            // Get the data attributes from the button
            const quality = target.dataset.quality;
            const degree = target.dataset.degree;
            const isTritone = target.classList.contains('tritone');
            
            // Handle tritone button specially
            if (isTritone) {
                // A tritone can be recognized as either an augmented 4th or diminished 5th
                const isTritoneInterval = currentItem.value.semitones === 6;
                
                if (isTritoneInterval) {
                    score++;
                    document.getElementById('score').textContent = score;
                    showSuccessMessage("Correct! That's a tritone.");
                    setTimeout(function() {
                        clearMessage();
                        generateNewNote();
                    }, 1000);
                } else {
                    showFailMessage("That's not a tritone!");
                    setTimeout(function() {
                        clearMessage();
                    }, 1000);
                }
                return;
            }
            
            // For non-tritone buttons, build the answer string
            if (quality) {
                currentItem.inputSoFar = quality;
            }
            
            if (degree) {
                currentItem.inputSoFar += degree;
            }
            
            // Check if we have a complete answer (both quality and degree)
            if (currentItem.inputSoFar.length >= 2) {
                if (currentItem.inputSoFar === expectedRootKey) {
                    // Correct answer
                    score++;
                    document.getElementById('score').textContent = score;
                    showSuccessMessage("Correct!");
                    setTimeout(function() {
                        clearMessage();
                        generateNewNote();
                    }, 1000);
                } else {
                    // Wrong answer
                    showFailMessage("Try again!");
                    currentItem.inputSoFar = ""; // Reset input
                    setTimeout(function() {
                        clearMessage();
                    }, 1000);
                }
            }
        }
        
        function checkInterval(answer) {
            console.log(`Checking interval: expected=${expectedRootKey}, got=${answer}`);
            
            const isCorrect = (answer === expectedRootKey) || 
                             (answer === 'tritone' && currentItem.value.isTritone);
            
            // Add visual feedback and update score
            if (isCorrect) {
                score++;
                document.getElementById('score').textContent = score;
                showSuccessMessage("Correct!");
                
                // Reset the buttons after a brief delay
                setTimeout(function() {
                    document.querySelectorAll('.interval-button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    
                    // Clear the currently selected quality and degree
                    if (currentItem) {
                        currentItem.selectedQuality = null;
                        currentItem.selectedDegree = null;
                    }
                    
                    // Clear the message and generate a new question
                    clearMessage();
                    generateNewNote();
                }, 1000);
            } else {
                // For incorrect answers, just show a message but don't move to the next question
                showFailMessage("Try again!");
                setTimeout(function() {
                    clearMessage();
                }, 1000);
            }
        }

        // Function to generate interval choice buttons
        function generateIntervalChoiceButtons(options, correctAnswer) {
            const choiceContainer = document.querySelector('.interval-choice-buttons');
            choiceContainer.innerHTML = ''; // Clear previous buttons
            
            // Apply CSS class based on number of options
            const numOptions = options.length;
            choiceContainer.className = 'interval-choice-buttons options-' + numOptions;
            
            // Shuffle the options array to randomize button order
            const shuffledOptions = shuffleArray([...options]);
            
            // Create a button for each option
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'interval-choice-btn';
                button.textContent = option;
                button.dataset.interval = option;
                button.addEventListener('click', handleIntervalChoiceClick);
                choiceContainer.appendChild(button);
            });
            
            // Debug output
            console.log(`Generated ${numOptions} interval options. Difficulty level: ${numOptions}`);
        }
        
        // Function to handle interval choice button clicks
        function handleIntervalChoiceClick(event) {
            if (!currentItem || currentItem.type !== 'interval' || !gameActive || gamePaused) return;
            
            // Get all choice buttons
            const allButtons = document.querySelectorAll('.interval-choice-btn');
            
            // Remove any previous selections or feedback
            allButtons.forEach(btn => {
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Get the selected button and answer
            const selectedButton = event.target;
            const selectedAnswer = selectedButton.dataset.interval;
            
            // Highlight the selected button
            selectedButton.classList.add('selected');
            
            // Store the selected answer
            currentItem.selectedAnswer = selectedAnswer;
            
            // Check if the answer is correct
            const isCorrect = selectedAnswer === currentItem.value.name;
            
            if (isCorrect) {
                // Highlight the button as correct
                selectedButton.classList.add('correct');
                
                // --- Call the main correctAnswer function --- 
                // It handles score, stats, feedback, and moving to the next item.
                // Pass null for event as it wasn't a keyboard press.
                correctAnswer(null); 

                // Remove the old direct score/feedback logic:
                // score++;
                // document.getElementById('score').textContent = score;
                // showSuccessMessage("Correct!");
                // setTimeout(() => {
                //     clearMessage();
                //     generateNewNote();
                // }, 1200);

            } else {
                // Highlight the selected button as incorrect
                selectedButton.classList.add('incorrect');
                
                // Find and highlight the correct button
                allButtons.forEach(btn => {
                    if (btn.dataset.interval === currentItem.value.name) {
                        btn.classList.add('correct');
                    }
                });
                
                // --- Call the main incorrectAnswer function --- 
                // It handles feedback and moving to the next item.
                incorrectAnswer(`Incorrect. The interval was ${currentItem.value.name}.`);
                
                // Remove the old direct feedback logic:
                // showFailMessage("Incorrect!");
                // setTimeout(() => {
                //     clearMessage();
                //     generateNewNote();
                // }, 2000);
            }
        }
        
        // Function to generate interval options (1 correct + variable number of incorrect)
        function generateIntervalOptions(correctInterval, numberOfOptions = 5) {
            // Ensure numberOfOptions is at least 2 and at most 5
            numberOfOptions = Math.max(2, Math.min(5, numberOfOptions));
            
            // Define all possible interval names
            const allIntervals = [
                'Perfect Unison', 'Minor 2nd', 'Major 2nd', 'Minor 3rd', 'Major 3rd',
                'Perfect 4th', 'Tritone', 'Perfect 5th',
                'Minor 6th', 'Major 6th', 'Minor 7th', 'Major 7th', 'Perfect 8th',
                'Augmented Unison', 'Diminished 2nd', 'Augmented 2nd', 'Diminished 3rd',
                'Augmented 3rd', 'Diminished 4th', 'Augmented 5th', 'Diminished 6th',
                'Augmented 6th', 'Diminished 7th', 'Augmented 7th', 'Diminished 8th'
            ];
            
            // Make sure our interval list includes ALL possible interval types
            // including augmented unison which is an important interval
            const completeIntervalList = [
                'Perfect Unison', 'Augmented Unison', 
                'Diminished 2nd', 'Minor 2nd', 'Major 2nd', 'Augmented 2nd',
                'Diminished 3rd', 'Minor 3rd', 'Major 3rd', 'Augmented 3rd',
                'Diminished 4th', 'Perfect 4th', 'Augmented 4th', 'Tritone',
                'Diminished 5th', 'Perfect 5th', 'Augmented 5th',
                'Diminished 6th', 'Minor 6th', 'Major 6th', 'Augmented 6th',
                'Diminished 7th', 'Minor 7th', 'Major 7th', 'Augmented 7th',
                'Diminished 8th', 'Perfect 8th', 'Augmented 8th'
            ];
            
            // Ensure the list has our correct interval
            if (!completeIntervalList.includes(correctInterval.name)) {
                completeIntervalList.push(correctInterval.name);
            }
            
            // Remove the correct answer from the possible options
            const availableOptions = completeIntervalList.filter(interval => interval !== correctInterval.name);
            
            // Shuffle the available options
            const shuffledOptions = shuffleArray(availableOptions);
            
            // Take the first (numberOfOptions-1) options
            const incorrectOptions = shuffledOptions.slice(0, numberOfOptions - 1);
            
            // Add the correct answer and return
            return [...incorrectOptions, correctInterval.name];
        }
        
        // Function to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Function to handle when user clicks a piano key
        function handleKeyClick(event) {
            if (!gameActive || gamePaused) return;
            
            // Get the note associated with the clicked key
            const noteValue = event.currentTarget.dataset.note;
            
            if (noteValue) {
                // Simulate a key press with the note value
                const keyEvent = {
                    key: noteValue.toLowerCase(),
                    shiftKey: noteValue.includes('#') || noteValue.includes('b'),
                    altKey: noteValue.includes('b')
                };
                
                handleKeyPress(keyEvent);
            }
        }
    </script>

    <!-- Add a script to test the initial rendering of the staff -->
    <script>
        // On page load, add a test for the abcjs library
        window.addEventListener('load', function() {
            // Allow some time for the script to load
            setTimeout(checkAbcjsAndRender, 500);
            
            // Check and retry a few times if the library isn't loaded yet
            let retries = 0;
            const maxRetries = 5;
            
            function checkAbcjsAndRender() {
                // Check if the abcjs library loaded correctly
                if (typeof ABCJS !== 'undefined') {
                    console.log("abcjs library loaded successfully!");
                    
                    // Try to render a test note when the page loads
                    try {
                        // Make sure the placeholder is hidden
                        const placeholder = document.getElementById('staff-placeholder');
                        if (placeholder) placeholder.style.display = 'none';
                        
                        // Render a test grand staff with middle C
                        const testAbc = "X:1\nM:4/4\nL:1/4\nK:clef=treble\nV:1 clef=treble\nV:2 clef=bass\n" +
                                       "[V:1] z z z z z |]\n" +
                                       "[V:2] z z C, z z |]";
                        
                        ABCJS.renderAbc('staff-area', testAbc, {
                            scale: 1.6,
                            staffwidth: 400,
                            paddingtop: 10,
                            paddingbottom: 10,
                            paddingleft: 0,
                            paddingright: 0,
                            responsive: "resize",
                            add_classes: true
                        });
                        
                        // Apply the same styling as in renderStaff
                        const svg = document.querySelector('#staff-area svg');
                        if (svg) {
                            svg.style.display = 'block';
                            svg.style.margin = '0 auto';
                            svg.style.filter = 'drop-shadow(0 0 1px rgba(0, 255, 0, 0.3))';
                            
                            // Style staff lines
                            const staffLines = svg.querySelectorAll('path');
                            staffLines.forEach(line => {
                                line.setAttribute('stroke', '#3dff3d');
                                line.setAttribute('stroke-opacity', '1.0');
                                line.setAttribute('stroke-width', '1.2');
                            });
                        }
                        console.log("Test note rendered successfully!");
                    } catch (e) {
                        console.error("Error rendering test note:", e);
                        document.getElementById('staff-area').innerHTML = 
                            '<div style="color:red;">Error rendering staff: ' + e.message + '</div>';
                    }
                } else {
                    retries++;
                    console.warn(`abcjs library not found yet! Retry ${retries}/${maxRetries}`);
                    
                    if (retries < maxRetries) {
                        // Try again in 500ms
                        setTimeout(checkAbcjsAndRender, 500);
                    } else {
                        console.error("abcjs library not loaded after multiple attempts");
                        const downloadLink = 'https://github.com/paulrosen/abcjs/releases/download/v6.2.2/abcjs-basic-min.js';
                        document.getElementById('staff-placeholder').innerHTML = 
                            `<div style="color:red;">
                                Error: abcjs library not loaded. 
                                <p>Options to fix:</p>
                                <ol>
                                    <li><button onclick="window.location.reload()">Reload Page</button></li>
                                    <li><a href="${downloadLink}" download>Download abcjs library</a> and add it to your project folder</li>
                                </ol>
                            </div>`;
                    }
                }
            }
        });*
    </script>

    <!-- Web MIDI Integration -->
    <script>
        // Initialize MIDI as soon as the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMIDI();
        });

        // Function to initialize MIDI access
        async function initMIDI() {
            try {
                // Check if the Web MIDI API is supported
                if (!navigator.requestMIDIAccess) {
                    console.warn("Web MIDI API is not supported in this browser");
                    return;
                }

                // Request MIDI access
                const midiAccess = await navigator.requestMIDIAccess();
                
                // Add a MIDI connection status indicator to the game
                const gameStats = document.querySelector('.game-stats');
                if (gameStats) {
                    const midiStatusBox = document.createElement('div');
                    midiStatusBox.className = 'stat-box';
                    midiStatusBox.innerHTML = `
                        <div class="stat-icon">🎹</div>
                        <div class="stat-label">MIDI</div>
                        <div class="stat-value" id="midi-status">Connected</div>
                    `;
                    gameStats.appendChild(midiStatusBox);
                }
                
                // Log MIDI access success
                console.log("MIDI Access granted!", midiAccess);
                
                // Set up event handlers for MIDI inputs
                const inputs = midiAccess.inputs.values();
                let inputCount = 0;
                
                // For each MIDI input, set up a message handler
                for (let input = inputs.next(); input && !input.done; input = inputs.next()) {
                    input.value.onmidimessage = handleMIDIMessage;
                    inputCount++;
                    console.log(`MIDI Input: ${input.value.name}`);
                }
                
                if (inputCount === 0) {
                    console.log("No MIDI devices detected. Please connect a MIDI device and refresh the page.");
                    if (document.getElementById('midi-status')) {
                        document.getElementById('midi-status').textContent = "No Device";
                        document.getElementById('midi-status').style.color = "#ff9";
                    }
                }
                
                // Set up listeners for MIDI connection/disconnection events
                midiAccess.onstatechange = function(event) {
                    const midiStatus = document.getElementById('midi-status');
                    if (event.port.type === 'input') {
                        if (event.port.state === 'connected') {
                            console.log(`MIDI device connected: ${event.port.name}`);
                            if (midiStatus) {
                                midiStatus.textContent = "Connected";
                                midiStatus.style.color = "#0f0";
                            }
                        } else if (event.port.state === 'disconnected') {
                            console.log(`MIDI device disconnected: ${event.port.name}`);
                            if (midiStatus) {
                                midiStatus.textContent = "Disconnected";
                                midiStatus.style.color = "#f00";
                            }
                        }
                    }
                };
                
            } catch (error) {
                console.error("Error accessing MIDI devices:", error);
                const midiStatus = document.getElementById('midi-status');
                if (midiStatus) {
                    midiStatus.textContent = "Error";
                    midiStatus.style.color = "#f00";
                }
            }
        }

        // Handle incoming MIDI messages
        function handleMIDIMessage(event) {
            // Extract MIDI message data
            const [status, note, velocity] = event.data;
            
            // Check if it's a Note On message (144-159) with velocity > 0
            if (status >= 144 && status <= 159 && velocity > 0) {
                // Convert MIDI note number to note name
                const noteName = midiNoteNumberToName(note);
                
                // Process the note through the existing game logic
                processMIDINote(noteName);
            }
            // Note: We're ignoring Note Off messages and other MIDI message types
        }

        // Convert MIDI note number to note name
        function midiNoteNumberToName(midiNote) {
            // Calculate the base note (0-11 for C through B)
            const baseNoteIndex = midiNote % 12;
            
            // Get the note name from the existing notes array
            const noteName = notes[baseNoteIndex];
            
            // Calculate octave (C4/Middle C is MIDI note 60)
            const octave = Math.floor(midiNote / 12) - 1;
            
            // Return the note name with octave (e.g., "C4", "C#4")
            return noteName + octave;
        }

        // Process a MIDI note through the game's existing logic
        function processMIDINote(noteWithOctave) {
            // Extract just the note name without the octave
            const noteName = noteWithOctave.replace(/\d+$/, '');
            
            // Determine if we need to use shiftKey (for accidentals)
            const hasAccidental = noteName.includes('#') || noteName.includes('b');
            
            // Get the base note letter (C, D, E, etc.)
            const noteLetter = noteName.charAt(0).toLowerCase();
            
            // Create a synthetic keyboard event that matches what handleKeyPress expects
            const syntheticEvent = {
                key: noteLetter,
                shiftKey: hasAccidental,
                // Include altKey if your game uses it for specific purposes
                altKey: false,
                // Add a flag to identify this as a MIDI-generated event
                isMIDIEvent: true,
                // Add client coordinates for points animation (center of the staff area)
                clientX: staffArea.offsetLeft + (staffArea.offsetWidth / 2),
                clientY: staffArea.offsetTop + (staffArea.offsetHeight / 2),
                // Prevent default to avoid conflicts
                preventDefault: function() {}
            };
            
            // Log the MIDI note being processed (for debugging)
            console.log(`MIDI Note: ${noteWithOctave} → Key: ${noteLetter}, Shift: ${hasAccidental}`);
            
            // Send the synthetic event to the existing handleKeyPress function
            if (gameActive && !gamePaused) {
                // Display the MIDI note visually in the feedback area for a moment
                const originalFeedback = feedbackArea.textContent;
                const originalClass = feedbackArea.className;
                
                // Show a visual indicator that a MIDI key was pressed
                feedbackArea.textContent = `MIDI: ${noteName}`;
                feedbackArea.className = 'intermediate';
                
                // Process the note through the existing game logic
                setTimeout(() => {
                    // Only reset the feedback if it hasn't been changed by the game logic
                    if (feedbackArea.textContent === `MIDI: ${noteName}`) {
                        feedbackArea.textContent = originalFeedback;
                        feedbackArea.className = originalClass;
                    }
                    
                    // Call the existing handler
                    handleKeyPress(syntheticEvent);
                }, 200);
            }
        }
    </script>

    <footer>
        Created by Brian Wahlstrom
    </footer>

</body>
</html>